SELECT MAX(CODIGO) AS CODIGO FROM MAESTRO.JERARQUIA_PRODUCTO;

UPDATE MAESTRO.JERARQUIA_PRODUCTO AS C
SET DESC_ARTICULO=COALESCE (P.DESC_ARTICULO,'NO APLICA'),
	TIPO_ARTICULO= COALESCE (P. TIPO_ARTICULO,'99'),
	CODI_LINEA= COALESCE (P. CLASE_ARTICULO,'99'), 
	CODI_PRESENTACION=  COALESCE(P.CODI_PRESENTACION,'99'),  
	CODI_TAMANO=  COALESCE (P. CODI_TAMANO,'99'),  
	CODI_SUBGRUPO=  COALESCE (P. CODI_SUBGRUPO,'99'),  
	CODI_GRUPO=  COALESCE (P. CODI_GRUPO,'99'), 
	OFERTA_ARTICULO=P.CONTROL_MULT,
	FACT_CONVER= P.FACT_CONVER,
	CODI_DESC=CONCAT(P.CODI_ARTICULO,'-',P.DESC_ARTICULO),
	TIPO_IVA=P.TIPO_IVA,
	CODIGO_BARRAS=P.BARC35
	
FROM (
	-- limpieza de espacios en PRODUCTO
	SELECT * REPLACE(
		COALESCE (DESC_ARTICULO,'NO APLICA') AS DESC_ARTICULO ,
	COALESCE ( TIPO_ARTICULO,'99') AS TIPO_ARTICULO,
	COALESCE (CLASE_ARTICULO,'99') AS CLASE_ARTICULO , 
	COALESCE (CODI_PRESENTACION,'99')  AS CODI_PRESENTACION ,  
	COALESCE ( CODI_TAMANO,'99') AS CODI_TAMANO,  
	COALESCE (CODI_SUBGRUPO,'99') AS CODI_SUBGRUPO,  
	  COALESCE (CODI_GRUPO,'99') AS CODI_GRUPO, 
	  CONTROL_MULT as CONTROL_MULT,    
	  CAST(FACT_CONVER AS NUMERIC )    AS FACT_CONVER,
   	TIPO_IVA AS TIPO_IVA,
	BARC35 AS BARC35
	) 
	FROM MAESTRO.PRODUCTO
) P
WHERE P.CODI_EMPRESA=C.CODI_EMPRESA 
	AND P.CODI_ARTICULO=C.CODI_ARTICULO
;
INSERT INTO MAESTRO.JERARQUIA_PRODUCTO (CODIGO,
 CODI_EMPRESA, CODI_ARTICULO, DESC_ARTICULO, TIPO_ARTICULO, CODI_LINEA, 
		CODI_PRESENTACION, CODI_TAMANO, CODI_SUBGRUPO, CODI_GRUPO,
		 OFERTA_ARTICULO,     FACT_CONVER, CODI_COMPU, TIPO_IVA, CODIGO_BARRAS)
-- registros para insertar
SELECT ${CODIGO}  + ROW_NUMBER() OVER () AS CODIGO,
  P.CODI_EMPRESA, P.CODI_ARTICULO, P.DESC_ARTICULO, P.TIPO_ARTICULO, P.CLASE_ARTICULO, 
		P.CODI_PRESENTACION, P.CODI_TAMANO, P.CODI_SUBGRUPO, P.CODI_GRUPO, 
	 P.CONTROL_MULT,  P.FACT_CONVER, CONCAT(P.CODI_ARTICULO,'-',P.DESC_ARTICULO) AS CODI_COMPU,
	 P.TIPO_IVA , P.BARC35

FROM ( 
	-- limpieza de espacios en clientes_temp
	SELECT * REPLACE(
		COALESCE (DESC_ARTICULO,'NO APLICA') AS DESC_ARTICULO ,
	COALESCE (TIPO_ARTICULO,'99') AS TIPO_ARTICULO,
	COALESCE (CLASE_ARTICULO,'99') AS CLASE_ARTICULO , 
	COALESCE (CODI_PRESENTACION,'99') AS CODI_PRESENTACION ,  
	COALESCE ( CODI_TAMANO,'99') AS CODI_TAMANO,  
	COALESCE (CODI_SUBGRUPO,'99') AS CODI_SUBGRUPO,  
	  COALESCE (CODI_GRUPO,'99') AS CODI_GRUPO, 
	 CONTROL_MULT AS CONTROL_MULT, 
     CAST(FACT_CONVER AS NUMERIC )    AS FACT_CONVER,
	   TIPO_IVA AS TIPO_IVA,	
	   BARC35 AS BARC35

	) 
	FROM MAESTRO.PRODUCTO
) AS P
  LEFT JOIN MAESTRO.PRODUCTO C
    ON P.CODI_EMPRESA=C.CODI_EMPRESA 
      AND P.CODI_ARTICULO=C.CODI_ARTICULO
WHERE C.CODI_ARTICULO IS NULL
;
