SELECT FN.PERIODO() AS PERIODO;

INSERT INTO MAESTRO.DIM_TIEMPOS
(FECHA, PERIODO, ANO, MES, DIA, SEMANA, 
NUM_DIASEMANA, PESO_DIA, FECHA_DIA, FECHA_CORTA, DOMINGO, FESTIVO, NOMBRE_MES)
SELECT DISTINCT FECHA_FACTURA, 
${PERIODO},
EXTRACT(YEAR FROM FECHA_FACTURA) AS ANO,
EXTRACT(MONTH FROM FECHA_FACTURA) AS MES, 
EXTRACT(DAY FROM FECHA_FACTURA) AS DIA,
EXTRACT(WEEK FROM FECHA_FACTURA) AS SEMANA,
EXTRACT(DAYOFWEEK FROM FECHA_FACTURA) AS NUM_DIASEMANA,
0 AS PESO,
CONCAT(CAST(${PERIODO} AS STRING), '-', CAST(FORMAT_DATE("%Y/%m/%d", DATE(FECHA_FACTURA)) AS STRING)) AS FECHA_DIA,
CAST(FORMAT_DATE("%Y/%m/%d", DATE(FECHA_FACTURA)) AS STRING) AS FECHA_CORTA,
0,
0,
''  AS NOMBRE_MES
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL_FK
WHERE  PERIODO  = ${PERIODO}  
AND EXTRACT(MONTH FROM FECHA_FACTURA) <> CAST(EXTRACT(MONTH FROM CURRENT_DATE("America/Bogota")) AS INT64)
AND CAST(FORMAT_DATE("%Y/%m/%d", DATE(FECHA_FACTURA)) AS STRING)
NOT IN 
(SELECT CAST(FORMAT_DATE("%Y/%m/%d", DATE(FECHA)) AS STRING)
FROM MAESTRO.DIM_TIEMPOS
WHERE  PERIODO  = ${PERIODO}
)
ORDER BY FECHA_FACTURA;

UPDATE MAESTRO.DIM_TIEMPOS
SET PESO_DIA=P.PESO_CANATRAD
FROM MAESTRO.DIM_TIEMPOS AS T, MAESTRO.TABLA_PROYECCION AS P
WHERE T.PERIODO=P.PERIODO
AND CAST(FORMAT_DATE("%Y/%m/%d", DATE(T.FECHA)) AS STRING) = CAST(FORMAT_DATE("%Y/%m/%d", DATE(P.FECHA)) AS STRING)
AND T.PERIODO = ${PERIODO}
AND CAST(FORMAT_DATE("%Y/%m/%d", DATE(T.FECHA)) AS STRING) <= CAST(FORMAT_DATE("%Y/%m/%d", DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS STRING);

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL_FK
SET  ID_FECHA=C.CODIGO
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL_FK AS V  INNER JOIN MAESTRO.DIM_TIEMPOS AS C 
ON CAST(FORMAT_DATE("%Y/%m/%d", DATE(V.FECHA_FACTURA)) AS STRING) = CAST(FORMAT_DATE("%Y/%m/%d", DATE(C.FECHA)) AS STRING)
AND V.PERIODO=C.PERIODO
WHERE TRIM(V.CODI_EMPRESA) IN ('FK')
AND ( V.ID_FECHA=0 OR V.ID_FECHA IS NULL);

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL_FK
SET  ID_FECH_REQ=C.CODIGO		   
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL_FK AS V INNER JOIN MAESTRO.DIM_TIEMPOS AS  C 
ON CAST(FORMAT_DATE("%Y/%m/%d", DATE(V.FECHA_REQU_PED)) AS STRING) = CAST(FORMAT_DATE("%Y/%m/%d", DATE(C.FECHA)) AS STRING)
AND V.PERIODO=C.PERIODO
WHERE TRIM(V.CODI_EMPRESA) IN ('FK')
AND ( V.ID_FECH_REQ=0 OR V.ID_FECH_REQ IS NULL);