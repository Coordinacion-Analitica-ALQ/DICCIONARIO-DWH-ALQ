DECLARE periodop INT64 DEFAULT CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);

DELETE LOGISTICA.PEDIDOS_vs_DESPACHOS
where PERIODO= periodop
AND FORMAT_DATE("%Y/%m/%d", FECHA_REQUERIDA) >= FORMAT_DATE("%Y/%m/%d", CURRENT_DATE("America/Bogota")) 
and CODI_EMPRESA IN ('DN','GA');

INSERT INTO LOGISTICA.PEDIDOS_vs_DESPACHOS
( PERIODO, CODI_EMPRESA, FECHA_REQUERIDA, CODI_CLIENTE, SECUENCIA, CODI_ARTICULO, CODIGO_CLIENTE, 
CODI_ARTEMP, ID_FECHA_REQUERIDA, CODI_ESTRUCTURA, NOVEDAD, CODIGO_NOVEDAD, ESTADO_PEDIDO, 
ID_MODIFICADO, NUMERO_PEDIDO, LINEA_PEDIDO, FACTOR, CANTIDAD_PEDIDO, CANTIDAD_DESPACHO, CANTIDAD_NUEVA, LITRO_PEDIDO, LITRO_DESPACHADO, 
DIFERENCIA, LITRO_PEDINUEV, ESTADO_PEDIDO_FIN,FECHA_PEDIDO,ORIGEN_PEDIDO,CODI_ESTADO_LINEA, CODI_ESTADO_PEDIDO,CODIGO_CTROTUNIF,PK_CAUSA
,VALOR_TOTAL,PRECIO_UNITARIO)

SELECT distinct  P.PERIODO, C.CODI_EMPRESA, TIMESTAMP(PARSE_DATE("1%y%m%d", CAST(P.FECHA_REQUERIDA AS STRING))) AS FECHA_REQUERIDA, 
P.CODI_CLIENTE, P.SECUENCIA, 
K.CODI_ARTICULO,C.CODIGO CODIGO_CLIENTE,K.CODIGO CODI_ARTEMP,T.CODIGO ID_FECHA_REQUERIDA,0 CODI_ESTRUCTURA, N.NOVEDAD, 
CODIGO_NOVEDAD, P.ESTADO_PEDIDO ESTADO_PEDIDO, M.ID_MODIFICADO , NUMERO_PEDIDO, LINEA_PEDIDO, 
FACTOR, CANTIDAD_PEDIDO, 
CANTIDAD_DESPACHO, CANTIDAD_NUEVA, LITRO_PEDIDO, LITRO_DESPACHADO, 
DIFERENCIA, LITRO_PEDINUEV, P.ESTADO_PEDIDO_TOTAL, TIMESTAMP(PARSE_DATE("1%y%m%d", CAST(P.FECHA_PEDIDO AS STRING))) AS FECHA_PEDIDO,ORIGEN_PEDIDO,
CASE WHEN P.ESTADO_PEDIDO='C' THEN 3 ELSE
CASE WHEN P.ESTADO_PEDIDO=  'X'  THEN 2  ELSE 1 END END  CODI_ESTADO_LINEA,
CASE WHEN P.ESTADO_PEDIDO_TOTAL='C' THEN 3 ELSE
CASE WHEN P.ESTADO_PEDIDO_TOTAL='X' THEN 2 ELSE 1  END  END CODI_ESTADO_PEDIDO ,
CODIGO_CTROTUNIFICADO,PK_CAUSA,VALOR_TOTAL,PRECIO_UNITARIO
FROM   LOGISTICA.PEDIDOS_vs_DESPACHOS_HOY AS P INNER JOIN  MAESTRO.DIM_MODIFICADO M on 
P.MODIFICADO=M.CODI_MODIFICADO 
INNER JOIN MAESTRO.DIM_NOVEDAD N ON P.CODIGO_NOVEDAD=N.IDX_NOVEDAD	  
INNER JOIN MAESTRO.CLIENTES C ON P.CODI_EMPRESA=C.CODI_EMPRESA AND P.CODI_CLIENTE=C.CODI_CLIENTE AND P.SECUENCIA=C.DIRE_ENTREGA
INNER JOIN MAESTRO.JERARQUIA_PRODUCTO K ON K.CODI_EMPRESA=P.CODI_EMPRESA AND K.CODI_ARTICULO=P.CODI_ARTICULO
INNER JOIN MAESTRO.DIM_TIEMPOS T ON T.PERIODO=P.PERIODO 
AND CAST(FORMAT_DATE("1%y%m%d", T.FECHA) AS INT64) = P.FECHA_REQUERIDA
WHERE P.PERIODO=periodop
ORDER BY PERIODO,C.CODI_EMPRESA,ID_FECHA_REQUERIDA,NUMERO_PEDIDO,LINEA_PEDIDO, CODIGO_CLIENTE,CODI_ARTEMP

