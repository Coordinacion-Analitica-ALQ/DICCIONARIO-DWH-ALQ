DECLARE periodop INT64 DEFAULT CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);
DECLARE diashmes NUMERIC DEFAULT CAST(COALESCE((SELECT DIAS_HABILES FROM COMERCIAL.PERIODO_DIASH WHERE PERIODO = periodop LIMIT 1),1) AS NUMERIC);
DECLARE dia_lineal NUMERIC DEFAULT CAST(COALESCE((SELECT SUM(PESO_DIA) FROM MAESTRO.DIM_TIEMPOS 
WHERE PERIODO = periodop
AND FORMAT_DATE("%Y/%m/%d", DATE(FECHA)) <= FORMAT_DATE("%Y/%m/%d", CURRENT_DATE("America/Bogota")) LIMIT 1),1) AS NUMERIC);

DELETE COMERCIAL.VENTA_INDICADORES_TOTALFK WHERE PERIODO=periodop;

INSERT INTO COMERCIAL.VENTA_INDICADORES_TOTALFK 
( PERIODO, CODIGO_CLIENTE, CODI_ARTEMP, CODI_CAUSA, NUM_INTERNO, TIPO_DOCU, CODI_ESTRUCUTRA, LITRO_NETO, VALOR_NETO, LITRO_NC, VALOR_NC
,CODI_SUBCAUSA, VALOR_FACTURADO, CODIGO_SUBCAUSAL, CODIGO_CAUSAL,VALOR_PROYECCION,
LITRO_PROYECCION,FACTURADO_PROYECCION,DIAS_HAB_TRANSC,DIAS_TOT_MES,DIAS_LINEAL,VALOR_BRUTO ,VALOR_DESC, VALOR_DEVO ,DESC_POSV ,
UNIDAD_BRUTO , UNID_NC,UNID_NETO , CARTERA)
SELECT  V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA,NUM_INTERNO ,TIPO_DOCU,CODI_ESTRUCTURA, 
SUM(LITRO_NETO) LITRO_NETO ,SUM(VALOR_NETO) VALOR_NETO,SUM(LITRO_NC) LITRO_NC,SUM(VALOR_NC) VALOR_NC
,CODI_SUBCAUSA,SUM(VALOR_BRUTO)+SUM(VALOR_NC) AS VALOR_FACTURADO,V.CODIGO_SUBCAUSAL,V.CODIGO_CAUSAL,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(VALOR_NETO)/round(R.PESO_DIAHTRANS,2) )* diashmes ELSE 0  END AS VALOR_PROYECCION, 
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(LITRO_NETO)/round(R.PESO_DIAHTRANS,2) )* diashmes ELSE 0 END AS LITRO_PROYECCION,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN ((SUM(VALOR_BRUTO)+SUM(VALOR_NC))/round(R.PESO_DIAHTRANS,2))* diashmes  ELSE 0 END AS FACT_PROYECCION,
R.PESO_DIAHTRANS,diashmes,R.PESO_DIAHTRANS,--este dato se cambia por  @DIA_LINEAL sila proyeccion es lineal
sum( VALOR_BRUTO) ,sum(VALOR_DESC), sum(VALOR_DEVO) ,sum(DESC_POSV) ,
sum(UNIDAD_BRUTO)  , sum(UNID_NC),sum(UNID_NETO)  , sum(CARTERA)
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL  AS V    INNER JOIN 
MAESTRO.JERARQUIA_PRODUCTO AS P ON V.CODI_ARTEMP=P.CODIGO
INNER JOIN MAESTRO.CLIENTES AS C  ON V.CODIGO_CLIENTE=C.CODIGO
INNER JOIN MAESTRO.TABLEAU_PesoDiaRegional AS R ON R.CODI_REGIONAL=C.CODI_UNIDAD  
WHERE C.CODI_EMPRESA IN ('GA') --AND CODI_ESTRUCTURA IN (1,3,5,7)--
AND P.CODI_LINEA IN  (  '02',  '04', '07','08','A6','C4','D1','Z1'  )
AND C.CODI_CANALSUPE NOT IN ('DO','FK','IC')
AND (V.CODI_CLIENTE NOT IN ('DRP9991',  'DRP9992'))
AND R.PERIODO=V.PERIODO
AND ( V.PERIODO =periodop) 
AND FORMAT_DATE("%Y/%m/%d", DATE(V.FECHA_REQU_PED)) <= FORMAT_DATE("%Y/%m/%d", DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY))
AND P.CODI_ARTICULO <>'CARTGA'
AND V.INDICA_KIT <>2
GROUP BY V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA,NUM_INTERNO,TIPO_DOCU,CODI_ESTRUCTURA
,CODI_SUBCAUSA, CODIGO_SUBCAUSAL, CODIGO_CAUSAL,R.PESO_DIAHTRANS;
--ORDER BY PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,NUM_INTERNO,TIPO_DOCU,CODI_ESTRUCTURA


INSERT INTO COMERCIAL.VENTA_INDICADORES_TOTALFK
(  PERIODO, CODIGO_CLIENTE, CODI_ARTEMP, CODI_CAUSA, NUM_INTERNO, TIPO_DOCU, CODI_ESTRUCUTRA, LITRO_NETO, VALOR_NETO, LITRO_NC, VALOR_NC
,CODI_SUBCAUSA, VALOR_FACTURADO, CODIGO_SUBCAUSAL, CODIGO_CAUSAL,VALOR_PROYECCION,
LITRO_PROYECCION,FACTURADO_PROYECCION,DIAS_HAB_TRANSC,DIAS_TOT_MES,DIAS_LINEAL,VALOR_BRUTO ,VALOR_DESC, VALOR_DEVO ,DESC_POSV ,
UNIDAD_BRUTO , UNID_NC,UNID_NETO , CARTERA)
SELECT  V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA, NUM_INTERNO ,TIPO_DOCU,CODI_ESTRUCTURA, 
SUM(LITRO_NETO) LITRO_NETO ,SUM(VALOR_NETO) VALOR_NETO,SUM(LITRO_NC) LITRO_NC,SUM(VALOR_NC) VALOR_NC
,CODI_SUBCAUSA,SUM(VALOR_BRUTO)+SUM(VALOR_NC) AS VALOR_FACTURADO,V.CODIGO_SUBCAUSAL,V.CODIGO_CAUSAL,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(VALOR_NETO)/round(R.PESO_DIAHTRANS,2) )* diashmes ELSE 0  END AS VALOR_PROYECCION, 
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(LITRO_NETO)/round(R.PESO_DIAHTRANS,2) )* diashmes ELSE 0 END AS LITRO_PROYECCION,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN ((SUM(VALOR_BRUTO)+SUM(VALOR_NC))/round(R.PESO_DIAHTRANS,2))* diashmes  ELSE 0 END AS FACT_PROYECCION,
R.PESO_DIAHTRANS,diashmes,R.PESO_DIAHTRANS, --este dato se cambia por  @DIA_LINEAL sila proyeccion es lineal
sum( VALOR_BRUTO) ,sum(VALOR_DESC), sum(VALOR_DEVO) ,sum(DESC_POSV) ,
sum(UNIDAD_BRUTO)  , sum(UNID_NC),sum(UNID_NETO)  , sum(CARTERA)
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL AS V INNER JOIN 
MAESTRO.JERARQUIA_PRODUCTO AS P ON V.CODI_ARTEMP=P.CODIGO
INNER JOIN MAESTRO.CLIENTES AS C ON  V.CODIGO_CLIENTE=C.CODIGO
INNER JOIN MAESTRO.TABLEAU_PesoDiaRegional AS R ON R.CODI_REGIONAL=C.CODI_UNIDAD  
WHERE C.CODI_EMPRESA IN ('DN')  
AND P.CODI_LINEA IN ('D1', 'C4','02','Z1' )
AND C.CODI_CANALSUPE NOT IN ('DO','FK','IC')
AND (V.CODI_CLIENTE NOT IN ('DRP9991',  'DRP9992'))
AND R.PERIODO=V.PERIODO
AND ( V.PERIODO =periodop) 
AND FORMAT_DATE("%Y/%m/%d", DATE(V.FECHA_REQU_PED)) <= FORMAT_DATE("%Y/%m/%d", DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY))
AND P.CODI_ARTICULO <>'CARTGA'
AND V.INDICA_KIT <>2
GROUP BY V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA, NUM_INTERNO,TIPO_DOCU,CODI_ESTRUCTURA
,CODI_SUBCAUSA, CODIGO_SUBCAUSAL, CODIGO_CAUSAL,R.PESO_DIAHTRANS;


INSERT INTO COMERCIAL.VENTA_INDICADORES_TOTALFK 
( PERIODO, CODIGO_CLIENTE, CODI_ARTEMP, CODI_CAUSA, NUM_INTERNO, TIPO_DOCU, CODI_ESTRUCUTRA, LITRO_NETO, VALOR_NETO, LITRO_NC, VALOR_NC
,CODI_SUBCAUSA, VALOR_FACTURADO, CODIGO_SUBCAUSAL, CODIGO_CAUSAL,VALOR_PROYECCION,
LITRO_PROYECCION,FACTURADO_PROYECCION,DIAS_HAB_TRANSC,DIAS_TOT_MES,DIAS_LINEAL
,VALOR_BRUTO ,VALOR_DESC, VALOR_DEVO ,DESC_POSV ,UNIDAD_BRUTO , 
UNID_NC,UNID_NETO , CARTERA)
SELECT  V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA, NUM_INTERNO ,TIPO_DOCU,7 CODI_ESTRUCTURA, 
SUM(LITRO_NETO) LITRO_NETO ,SUM(VALOR_NETO) VALOR_NETO,SUM(LITRO_NC) LITRO_NC,SUM(VALOR_NC) VALOR_NC
,CODI_SUBCAUSA,SUM(VALOR_BRUTO)+SUM(VALOR_NC) AS VALOR_FACTURADO,V.CODIGO_SUBCAUSA,V.CODIGO_CAUSAL,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(VALOR_NETO)/round(R.PESO_DIAHTRANS,2) )* diashmes ELSE 0  END AS VALOR_PROYECCION, 
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(LITRO_NETO)/round(R.PESO_DIAHTRANS,2) )* diashmes ELSE 0 END AS LITRO_PROYECCION,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN ((SUM(VALOR_BRUTO)+SUM(VALOR_NC))/round(R.PESO_DIAHTRANS,2))* diashmes  ELSE 0 END AS FACT_PROYECCION,
R.PESO_DIAHTRANS,diashmes,R.PESO_DIAHTRANS --este dato se cambia por  @DIA_LINEAL sila proyeccion es lineal
,sum( VALOR_BRUTO) ,sum(VALOR_DESC), sum(VALOR_DEVO) ,sum(DESC_POSV) ,
sum(UNIDAD_BRUTO)  , sum(UNID_NC),sum(UNID_NETO)  , sum(CARTERA)
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL_FK AS V INNER JOIN 
MAESTRO.JERARQUIA_PRODUCTO AS P ON V.CODI_ARTEMP=P.CODIGO
INNER JOIN MAESTRO.CLIENTES AS C ON V.CODIGO_CLIENTE=C.CODIGO
INNER JOIN MAESTRO.TABLEAU_PesoDiaRegional AS R ON R.CODI_REGIONAL=C.CODI_UNIDAD  
WHERE P.CODI_LINEA IN  (  '02',  '04',  '07','08','A6','C4','D1' ,'Z1' )
AND  CODI_CAUSA NOT IN ('F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'F13', 'F14', 'F15', 'F16', 'F17', 'F18', 'F19', 'F20')
AND C.CODI_CANALSUPE NOT IN ('DO','FK','IC')
AND (V.CODI_CLIENTE NOT IN ('DRP9991',  'DRP9992'))
AND R.PERIODO=V.PERIODO
AND ( V.PERIODO =periodop) 
AND FORMAT_DATE("%Y/%m/%d", DATE(FECHA_FACTURA)) <= FORMAT_DATE("%Y/%m/%d", DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY))
AND P.CODI_ARTICULO <>'CARTGA'
AND C.CODI_EMPRESA='FK'
GROUP BY V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA, NUM_INTERNO,TIPO_DOCU,
CODI_SUBCAUSA, CODIGO_SUBCAUSA,CODIGO_CAUSAL,R.PESO_DIAHTRANS;

UPDATE COMERCIAL.VENTA_INDICADORES_TOTALFK
SET DIAS_TOT_MES=25.8
FROM COMERCIAL.VENTA_INDICADORES_TOTALFK AS V INNER JOIN MAESTRO.CLIENTES AS C
ON V.CODIGO_CLIENTE=C.CODIGO
WHERE V.PERIODO=11912  and C.CODI_UNIDAD='RES';