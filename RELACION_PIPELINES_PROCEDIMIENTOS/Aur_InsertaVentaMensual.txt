SELECT IF(EXTRACT(DAY FROM CURRENT_DATE("America/Bogota")) = 1,CONCAT("1",FORMAT_DATE("%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY))),CONCAT("1",FORMAT_DATE("%y%m",CURRENT_DATE("America/Bogota")))) AS PERIODO;

DELETE FROM COMERCIAL.VENTAS_REPORTE
WHERE PERIODO=${PERIODO}
AND CODI_EMPRESA IN ('GA','DN');

DELETE FROM  COMERCIAL.VENTAS_REPORTE_MENSUAL
WHERE ( CODI_ARTEMP=0 OR CODI_ARTEMP IS NULL)
AND CODI_EMPRESA IN   ('GA','DN') ;

update COMERCIAL.VENTAS_REPORTE_MENSUAL
SET PADRE_KIT=1, CODIGO_KIT='1'
,NOMBRE_KIT='PRODUCTO REGULAR'
WHERE PERIODO= ${PERIODO}
AND (PADRE_KIT=0);

INSERT INTO COMERCIAL.VENTAS_REPORTE (CODI_EMPRESA, NUM_INTERNO, CODI_ARTICULO, 
	UNIDAD_BRUTO, LITRO_BRUTO, 	VALOR_BRUTO, CODI_CLIENTE, FECHA_FACTURA, CODI_CANALSUPE, CODI_CANAL,
	 CODI_DISTRITO, CODI_ZONA, CLIE_DIRE, VALOR_NC, UNID_NC, LITRO_NC, VALOR_DESC, 
	VALOR_DEVO, UNID_NETO, VALOR_NETO, LITRO_NETO,  CODI_REGIONAL, 	CODI_CIUDAD,  NUME_INTERNO, CARTERA, PERIODO,  
	CODI_BODEGA,  VALOR_OTRAMONE, IVA_OTRAMONE, CODI_CAUSA, IVA, VALOR_UNITARIO, 
	TIPO_ARTFISCAL, TIPO_DOCU, CODI_ESTRUCTURA, CODI_ARTEMP, CODIGO_BODEMP, 
	CODIGO_CLIENTE, 	NUMERO_LEGAL, ID_FECHA, NUMERO_PEDIDO, CODI_SUBCAUSA, CODIGO_CAUSAL, CODIGO_SUBCAUSAL, 
	 FECHA_REQU_PED, ID_FECHA_REQ, 	INDICA_KIT, TOT_ARTKIT,  PADRE_KIT,
	 DESCU_ARTICULO,CODI_ESTR_COMER,IMPORTE,BASE,LINEA_NUMERO,DESC_POSV,CODIGO_KIT,
	NOMBRE_KIT ,	IVA_FISCAL,IVA_MANDATO,CUENTA_MANDATO,	NOMBRE_CTAMANDATO,CUENTA_FISCAL,
	NOMBRE_CTAFISCAL,TIPO_ARTMANDATO)

SELECT CODI_EMPRESA, NUM_INTERNO, CODI_ARTICULO, SUM(COALESCE(UNIDAD_BRUTO,0)) UNIDAD_BRUTO, 
	SUM(COALESCE(LITRO_BRUTO,0)) LITRO_BRUTO,SUM(COALESCE(VALOR_BRUTO,0))  VALOR_BRUTO,  CODI_CLIENTE, FECHA_FACTURA, 
	CODI_CANALSUPE, CODI_CANAL, CODI_DISTRITO, CODI_ZONA, CLIE_DIRE, SUM(COALESCE(VALOR_NC,0)) VALOR_NC, 
	SUM(COALESCE(UNID_NC,0)) UNID_NC, SUM(COALESCE(LITRO_NC,0)) LITRO_NC, SUM(COALESCE(VALOR_DESC,0)) VALOR_DESC,
	SUM(COALESCE(VALOR_DEVO,0)) VALOR_DEVO, SUM(COALESCE(UNID_NETO,0)) UNID_NETO, SUM(COALESCE(VALOR_NETO,0)) VALOR_NETO, 
	SUM(COALESCE(LITRO_NETO,0)) LITRO_NETO,	CODI_REGIONAL, CODI_CIUDAD,  NUME_INTERNO, 	
	SUM(COALESCE(CARTERA,0)) CARTERA, PERIODO, CODI_BODEGA, 
	SUM(COALESCE(VALOR_OTRAMONE,0)) VALOR_OTRAMONE, SUM(COALESCE(IVA_OTRAMONE,0)) IVA_OTRAMONE, 
	CODI_CAUSA, SUM(COALESCE(IVA,0)) IVA, SUM(COALESCE(VALOR_UNITARIO,0)) VALOR_UNITARIO , 
	TIPO_ARTFISCAL, TIPO_DOCU,COALESCE(CODI_ESTRUCTURA,0) CODI_ESTRUCTURA, CODI_ARTEMP, CODIGO_BODEMP, 
	CODIGO_CLIENTE, NUMERO_LEGAL, ID_FECHA,NUMERO_PEDIDO , 
	CODI_SUBCAUSA,CODIGO_CAUSAL,CODIGO_SUBCAUSAL,FECHA_REQU_PED,ID_FECHA_REQ,
	COALESCE(INDICA_KIT,0) INDICA_KIT, COALESCE(TOT_ARTKIT,0) TOT_ARTKIT, 
COALESCE(PADRE_KIT,0) PADRE_KIT, COALESCE(DESCU_ARTICULO,0) DESCU_ARTICULO, 
COALESCE(CODI_ESTR_COMER,0) CODI_ESTR_COMER ,COALESCE(IMPORTE,0) IMPORTE, COALESCE(BASE,0) BASE,  
COALESCE(LINEA_NUMERO,0) LINEA_NUMERO,  sum(COALESCE(DESC_POSV,0)) DESC_POSV
	,CODIGO_KIT,NOMBRE_KIT , IVA_FISCAL,IVA_MANDATO,CUENTA_MANDATO,	NOMBRE_CTAMANDATO,CUENTA_FISCAL,
	NOMBRE_CTAFISCAL,TIPO_ARTMANDATO
	 FROM  COMERCIAL.VENTAS_REPORTE_MENSUAL 
			WHERE  PERIODO=${PERIODO}
			AND FORMAT_DATE("%Y-%m-%d" , DATE(FECHA_REQU_PED))<=FORMAT_DATE("%Y-%m-%d",DATE_SUB(CURRENT_DATE('America/Bogota'), INTERVAL 1 DAY))
			AND CODI_EMPRESA IN ('DN','GA')  and    (CODIGO_SUBCAUSAL IS not NULL OR CODIGO_SUBCAUSAL<> 0)
 	and CODI_ARTICULO <> '99'
	GROUP BY CODI_EMPRESA, NUM_INTERNO, CODI_ARTICULO,CODI_CLIENTE, FECHA_FACTURA, 
	CODI_CANALSUPE, CODI_CANAL, CODI_DISTRITO, CODI_ZONA, CLIE_DIRE,CODI_REGIONAL, 
	CODI_CIUDAD,  NUME_INTERNO,PERIODO, CODI_BODEGA, CODI_CAUSA,
	TIPO_ARTFISCAL, TIPO_DOCU, CODI_ESTRUCTURA, CODI_ARTEMP, CODIGO_BODEMP, 
	CODIGO_CLIENTE, NUMERO_LEGAL, ID_FECHA,NUMERO_PEDIDO , CODI_SUBCAUSA,
	CODIGO_CAUSAL,CODIGO_SUBCAUSAL,FECHA_REQU_PED,ID_FECHA_REQ,
	INDICA_KIT,TOT_ARTKIT ,PADRE_KIT ,DESCU_ARTICULO,CODI_ESTR_COMER,IMPORTE,BASE,LINEA_NUMERO
	,CODIGO_KIT,NOMBRE_KIT ,	IVA_FISCAL,IVA_MANDATO,CUENTA_MANDATO,NOMBRE_CTAMANDATO,CUENTA_FISCAL,NOMBRE_CTAFISCAL,TIPO_ARTMANDATO;



