SELECT FN.PERIODO() AS PERIODO;

truncate table TEMP_DATOSCANALAGRUP;


INSERT INTO TEMP_DATOSCANALAGRUP
(PERIODO, CODI_EMPRESA, CODI_CANALAGRUPA, CODI_CANALSUPE, CODI_LINEA, 
CODI_GRUPO, CODI_SUBGRUPO, CODI_PRESETNACION, CODI_TAMANO, NOMB_EMPRESA, NOMB_CANALSUPEAGRUP, NOMB_CANALSUPE, 
NOMB_LINEA, NOMB_GRUPO, NOMB_SUBGRUPO, NOMB_TAMANO, NOMB_PRESENTACION,UNID_NETO, VALOR_NETO, LITRO_NETO, VALOR_NETO_AGRUPADO, LITRO_NETO_AGRUPADO, 
VALOR_NETO_CANALSUPE, LITRO_NETO_CANALSUPE, VALOR_NETO_LINEA, LITRO_NETO_LINEA, VALOR_NETO_GRUPO, LITRO_NETO_GRUPO, 
VALOR_NETO_SUBGRUPO, LITRO_NETO_SUBGRUPO, VALOR_NETO_PRESE, LITRO_NETO_PRESE, VALOR_NETO_TAMANO, LITRO_NETO_TAMANO, VALOR_NETO_TOTAL, 
LITRO_NETO_TOTAL, TOTALDIATRAD, TOTALDIASM, DIASTRAD, DIASSM, VALOR_NETO_EMPRESA, LITRO_NETO_EMPRESA)
select 
PERIODO, CODI_EMPRESA,CODI_CANALASOC, CODI_CANALSUPE, 
CODI_LINEA, CODI_GRUPO, CODI_SUBGRUPO, CODI_PRESENTACION, CODI_TAMANO,
DESC_EMPRESA, NOMBRE_CANALASOC,DESC_CANALSUPE,DESC_LINEA,
DESC_GRUPO, DESC_SUBGRUPO, DESC_TAMANO, DESC_PRESENTACION,  
SUM(UNID_NETO)/1000 UNID_NETO, SUM(VALOR_NETO)/1000 AS VALOR_NETO, 
SUM(LITRO_NETO)/1000  AS LITRO_NETO,
0 VALOR_NETO_AGRUPADO, 0 LITRO_NETO_AGRUPADO,
0 VALOR_NETO_CANALSUPE, 0 LITRO_NETO_CANALSUPE,
0 VALOR_NETO_LINEA,  0 LITRO_NETO_LINEA, 
0 VALOR_NETO_GRUPO, 0 LITRO_NETO_GRUPO, 0 VALOR_NETO_SUBGRUPO, 0 LITRO_NETO_SUBGRUPO, 
0 VALOR_NETO_PRESE,0  LITRO_NETO_PRESE,0  VALOR_NETO_TAMANO,0  LITRO_NETO_TAMANO, 
0  VALOR_NETO_TOTAL, 0 LITRO_NETO_TOTAL, 0 TOTALDIATRAD, 0 TOTALDIASM,
0  DIASTRAD, 0 DIASSM,0,0
from COMERCIAL.Aur_ConsultaReporteVenta
WHERE PERIODO=${PERIODO}
and CODI_EMPRESA='GA' AND CODI_LINEA NOT IN ('D1','D2','05','C4','DA')
and CODI_ARTICULO <> '4128'
GROUP BY PERIODO, CODI_EMPRESA, CODI_CANALASOC, CODI_CANALSUPE, 
CODI_LINEA, CODI_GRUPO, CODI_SUBGRUPO, CODI_PRESENTACION, CODI_TAMANO,
DESC_EMPRESA, NOMBRE_CANALASOC ,DESC_CANALSUPE,DESC_LINEA,
DESC_GRUPO, DESC_SUBGRUPO, DESC_TAMANO, DESC_PRESENTACION;


update TEMP_DATOSCANALAGRUP
set VALOR_NETO_TOTAL=PT.VALOR,
LITRO_NETO_TOTAL=PT.LITRO
FROM  TEMP_DATOSCANALAGRUP AS V 
INNER JOIN Aur_New_ViwPresupTotal AS PT
ON V.PERIODO=PT.PERIODO
WHERE  V.PERIODO=${PERIODO}
AND V.CODI_EMPRESA='GA';


update TEMP_DATOSCANALAGRUP
set VALOR_NETO_AGRUPADO=PN.VALOR,
LITRO_NETO_AGRUPADO=PN.LITRO
FROM  TEMP_DATOSCANALAGRUP V LEFT OUTER JOIN Aur_New_ViwPresupCanalAgrupado  PN 
ON   PN.CODI_CANALASO=V.CODI_CANALAGRUPA
AND V.PERIODO=PN.PERIODO
WHERE  V.PERIODO=${PERIODO}
AND V.CODI_EMPRESA='GA';



update TEMP_DATOSCANALAGRUP
set VALOR_NETO_LINEA=PN.VALOR,
LITRO_NETO_LINEA=PN.LITRO
FROM  TEMP_DATOSCANALAGRUP AS V LEFT OUTER JOIN Aur_New_ViwPresupLinea PN 
ON  PN.CODI_CANALAGRUP=V.CODI_CANALAGRUPA
AND V.CODI_LINEA=PN.CODI_LINEA 
AND V.PERIODO=PN.PERIODO
WHERE  V.PERIODO=${PERIODO}
AND  V.CODI_EMPRESA='GA';



update TEMP_DATOSCANALAGRUP
set VALOR_NETO_CANALSUPE=PN.VALOR,
LITRO_NETO_CANALSUPE=PN.LITRO
FROM  TEMP_DATOSCANALAGRUP V LEFT OUTER JOIN Aur_New_ViwPresupCanalSupe PN 
ON    PN.CODI_CANALAGRUP=V.CODI_CANALAGRUPA
AND V.CODI_LINEA=PN.CODI_LINEA 
AND V.PERIODO=PN.PERIODO
AND V.CODI_CANALSUPE=PN.CODI_CANALSUPE
WHERE  V.PERIODO=${PERIODO}
AND V.CODI_EMPRESA='GA';



update TEMP_DATOSCANALAGRUP
set VALOR_NETO_GRUPO=PN.VALOR,
LITRO_NETO_GRUPO=PN.LITRO
FROM  TEMP_DATOSCANALAGRUP V LEFT OUTER JOIN Aur_New_ViwPresupgrupo PN
ON PN.CODI_CANALAGRUP=V.CODI_CANALAGRUPA
AND V.CODI_CANALSUPE=PN.CODI_CANALSUPE
AND V.CODI_LINEA=PN.CODI_LINEA 
AND V.CODI_GRUPO=PN.CODI_GRUPO 
AND V.PERIODO=PN.PERIODO
WHERE  V.PERIODO=${PERIODO}
AND  V.CODI_EMPRESA='GA';


update TEMP_DATOSCANALAGRUP
set VALOR_NETO_SUBGRUPO=COALESCE (PN.VALOR,0),
LITRO_NETO_SUBGRUPO=COALESCE (PN.LITRO,0)
FROM  TEMP_DATOSCANALAGRUP V LEFT OUTER JOIN Aur_New_ViwPresupSubgrupo  PN 
ON PN.CODI_CANALAGRUP=V.CODI_CANALAGRUPA
AND V.CODI_LINEA=PN.CODI_LINEA 
AND V.CODI_CANALSUPE=PN.CODI_CANALSUPE   
AND V.CODI_GRUPO=PN.CODI_GRUPO 
AND V.CODI_SUBGRUPO=PN.CODI_SUBGRUPO 
AND V.PERIODO=PN.PERIODO
WHERE  V.PERIODO=${PERIODO}
AND  V.CODI_EMPRESA='GA';


update TEMP_DATOSCANALAGRUP
set VALOR_NETO_PRESE=PN.VALOR,
LITRO_NETO_PRESE=PN.LITRO
FROM  TEMP_DATOSCANALAGRUP V LEFT OUTER JOIN Aur_New_ViwPresupPresen PN 
ON   V.CODI_LINEA=PN.CODI_LINEA 
AND V.CODI_CANALSUPE=PN.CODI_CANALSUPE
AND V.CODI_GRUPO=PN.CODI_GRUPO 
AND V.CODI_SUBGRUPO=PN.CODI_SUBGRUPO 
AND V.PERIODO=PN.PERIODO
AND V.CODI_PRESETNACION=PN.CODI_PRESENTACION 
WHERE  V.PERIODO=${PERIODO}
AND  V.CODI_EMPRESA='GA';



update TEMP_DATOSCANALAGRUP
set VALOR_NETO_TAMANO=PN.VALOR,
LITRO_NETO_TAMANO=PN.LITRO
FROM  TEMP_DATOSCANALAGRUP V LEFT OUTER JOIN Aur_New_ViwPresupTamano PN ON   
PN.CODI_CANALAGRUP=V.CODI_CANALAGRUPA
AND V.CODI_LINEA=PN.CODI_LINEA 
AND V.CODI_CANALSUPE=PN.CODI_CANALSUPE
AND V.CODI_GRUPO=PN.CODI_GRUPO 
AND V.CODI_SUBGRUPO=PN.CODI_SUBGRUPO 
AND V.PERIODO=PN.PERIODO
AND V.CODI_PRESETNACION=PN.CODI_PRESENTACION 
AND V.CODI_TAMANO=PN.CODI_TAMANO 
WHERE  V.PERIODO=${PERIODO}
AND V.CODI_EMPRESA='GA';


UPDATE TEMP_DATOSCANALAGRUP
SET TOTALDIATRAD=CASE WHEN F.TOTALDIATRAD=0 THEN F.TOTALDIATRAD+1 ELSE F.TOTALDIATRAD END ,
TOTALDIASM=CASE WHEN F.TOTALDIASM=0 THEN F.TOTALDIASM+1 ELSE F.TOTALDIASM END ,
DIASTRAD=CASE WHEN F.DIASTRAD=0 THEN F.DIASTRAD+1 ELSE F.DIASTRAD END ,
DIASSM=CASE WHEN F.DIASSM=0 THEN F.DIASSM+1 ELSE F.DIASSM END
FROM TEMP_DATOSCANALAGRUP T INNER JOIN  FECHA_HOY  F
ON T.PERIODO=F.PERIODO_ACTUAL
where T.PERIODO=${PERIODO};

UPDATE TEMP_DATOSCANALAGRUP
SET NOMB_LINEA='DESC. VENTAS AUTORIZADOS'
WHERE CODI_LINEA='99';
