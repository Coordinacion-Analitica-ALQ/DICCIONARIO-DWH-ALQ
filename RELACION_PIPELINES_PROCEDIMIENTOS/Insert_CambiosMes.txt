DELETE MAESTRO.DATOS_CAMBIOMANO 
WHERE PERIODO=CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);

DECLARE DIA_LINEAL NUMERIC;
DECLARE DIASHMES FLOAT64;

SET DIA_LINEAL = (  SELECT CASE WHEN SUM(PESO_DIA)>0 THEN SUM(PESO_DIA) else 1 end 
                    FROM MAESTRO.DIM_TIEMPOS
                    WHERE PERIODO=CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64)
                    AND FORMAT_DATE("%Y/%m/%d",DATE(FECHA)) <= FORMAT_DATE("%Y/%m/%d", CURRENT_DATE("America/Bogota"))
                    LIMIT 1
                 );
                 
SET DIASHMES = ( SELECT DIAS_HABILES FROM COMERCIAL.PERIODO_DIASH WHERE PERIODO=CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64) LIMIT 1);

INSERT INTO MAESTRO.DATOS_CAMBIOMANO
(PERIODO,CODIGO_CLIENTE, CODI_ARTEMP, CODIGO_CAUSAL, NOMBRE_CAUSAL,CODIGO_SUBCAUSA, NOMBRE_SUBCAUSAL, DESCRIPCION,
LITRO_NETO, VALOR_NETO, LITRO_NC, VALOR_NC,VALOR_FACTURADO,VALOR_PROYECCION,LITRO_PROYECCION,FACTURADO_PROYECCION,
PROYECCION_NOTAC, PROYECCION_NOTAC_LITRO,CANTIDAD_PEDIDO,CANTIFDAD_DESPACHO,LITRO_PEDIDO,LITRO_DESPACHADO,VALOR_CAMBIO,
PROYECCION_CAMBIOLITRO ,PROYECCION_CAMBIOPESO) 

SELECT Cambios.PERIODO, Cambios.CODIGO_CLIENTE, Cambios.CODI_ARTEMP AS CODI_ARTEMP, 
'C'  AS CODIGO_CAUSAL , 'CAMBIO MANO A MANO' AS NOMBRE_CAUSAL,0 AS CODIGO_SUBCAUSA, 
'CAMBIO MANO A MANO' AS NOMBRE_SUBCAUSAL, 'Cambio' AS DESCRIPCION,
0 AS LITRO_NETO, 0 AS VALOR_NETO, 0 AS LITRO_NC, 0 AS VALOR_NC, 0 AS VALOR_FACTURADO, 0 AS VALOR_PROYECCION, 0 AS LITRO_PROYECCION, 
0 AS FACTURADO_PROYECCION,  0 AS PROYECCION_NOTAC, 0 AS PROYECCION_NOTAC_lITRO, 
CAST(SUM(Cambios.CANTIDAD_PEDIDO) AS INT64) AS CANTIDAD_PEDIDA, CAST(SUM(Cambios.CANTIDAD_DESPACHO) AS INT64) AS CANTIDAD_DESPACHO, 
CAST(SUM(Cambios.LITRO_PEDIDO) AS INT64) AS LITRO_PEDIDA, CAST(SUM(Cambios.LITRO_DESPACHADO) AS INT64) AS LITRO_DESPACHO, 
CAST(SUM(COALESCE(VALOR_TOTAL,0)) AS INT64) AS VALOR_TOTAL,
CAST((( CAST(sum(LITRO_DESPACHADO) AS INT64) / CAST(DIA_LINEAL AS INT64)) * CAST(DIASHMES AS INT64)) AS INT64) AS PROYECCIONCAMBIOLTRS , 
CAST(((SUM(COALESCE(VALOR_TOTAL,0))/DIA_LINEAL) * DIASHMES) AS INT64) AS PROYECCION_CAMBIOPESOS
FROM LOGISTICA.PEDIDOS_vs_DESPACHOS AS Cambios 
WHERE (Cambios.PERIODO = CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64))
AND    Cambios.ORIGEN_PEDIDO='C'
GROUP BY Cambios.PERIODO, Cambios.CODIGO_CLIENTE, Cambios.CODI_ARTEMP;