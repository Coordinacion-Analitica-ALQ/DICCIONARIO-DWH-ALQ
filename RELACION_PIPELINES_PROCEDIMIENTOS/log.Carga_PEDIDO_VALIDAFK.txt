DECLARE PERIODOP INT64;
SET PERIODOP = CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);

DELETE MAESTRO.FK_PEDIDO_DIA
WHERE PERIODO=CAST(PERIODOP AS STRING)
AND (CODIGO_CLIENTE IS NULL OR CODIGO_CLIENTE=0);

DELETE MAESTRO.FK_PEDIDO_DIA
WHERE PERIODO=CAST(PERIODOP AS STRING)
AND (CODI_ARTEMP IS NULL OR CODI_ARTEMP=0);

TRUNCATE TABLE LOGISTICA.PEDIDOS_vs_DESPACHOS_FK;

DECLARE PERIODOP INT64;
SET PERIODOP = CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);
  
INSERT INTO LOGISTICA.PEDIDOS_vs_DESPACHOS_FK
( PERIODO, CODI_EMPRESA, FECHA_REQUERIDA, CODI_CLIENTE, SECUENCIA, CODI_ARTICULO,  
NOVEDAD, ESTADO_PEDIDO, MODIFICADO, 
NUMERO_PEDIDO, LINEA_PEDIDO, CANTIDAD_PEDIDO, CANTIDAD_DESPACHO, CANTIDAD_NUEVA, LITRO_PEDIDO, LITRO_DESPACHADO, 
DIFERENCIA, LITRO_PEDINUEV, ESTADO_PEDIDO_TOTAL,CTROTRANSP_UNIFICADO,FECHA_PEDIDO,ORIGEN_PEDIDO)

SELECT CAST(P.PERIODO AS INT64) AS PERIODO,  CODI_EMPRESA,  
TIMESTAMP(FORMAT_DATE("%Y/%m/%d",DATE(FECHA_REQUERIDA))) AS FECHA_REQUERIDA,  
P.CODI_CLIENTE, P.SECUENCIA, P.CODI_ARTICULO,CASE WHEN P.ESTADO_PEDIDO='C' THEN 'Completo' ELSE 'Incompleto' END AS NOVEDAD, 
P.ESTADO_PEDIDO , P.MODIFICADO,
NUMERO_PEDIDO, 
CAST(LINEA_PEDIDO AS INT64) AS LINEA_PEDIDO, 
SUM(CAST(P.CANTIDAD_PEDIDO AS NUMERIC)) AS CANTIDAD_PEDIDO,   
SUM(CAST(P.CANTIDAD_DESPACHO AS NUMERIC))  AS CANTIDAD_DESPACHO,
SUM(CAST(P.CANTIDAD_NUEVA AS NUMERIC)) AS CANTIDAD_NUEVA,   
SUM(CAST(P.LITRO_PEDIDO AS NUMERIC)) AS LITRO_PEDIDO, 
SUM(CAST(P.LITRO_DESPACHADO AS NUMERIC)) AS LITRO_DESPACHADO,    
SUM(CAST(P.LITRO_PEDIDO AS NUMERIC) - CAST(P.LITRO_DESPACHADO AS NUMERIC)) AS DIFERENCIA, 
SUM(CAST(P.LITRO_PEDINUEV AS NUMERIC)) AS LITRO_PEDINUEV,   
P.ESTADO_PEDIDO_TOTAL, CAST(CODIGO_CTROTUNIF AS STRING), TIMESTAMP(FORMAT_DATE("%Y/%m/%d",DATE(P.FECHA_PEDIDO))) AS FECHA_PEDIDO,
ORIGEN_PEDIDO
FROM MAESTRO.FK_PEDIDO_DIA  AS P
WHERE P.PERIODO  = CAST(PERIODOP AS STRING) 
AND LENGTH(CODI_ARTICULO)>0
GROUP BY P.PERIODO,  CODI_EMPRESA, P.FECHA_REQUERIDA,  P.ESTADO_PEDIDO,NUMERO_PEDIDO,LINEA_PEDIDO,P.ESTADO_PEDIDO_TOTAL
,P.FECHA_PEDIDO, P.CODI_CLIENTE, P.SECUENCIA,P.CODI_ARTICULO,    P.MODIFICADO, ORIGEN_PEDIDO,P.CODIGO_CLIENTE,  P.CODI_ARTEMP,CODI_EQUIVALENCIA,CODIGO_CTROTUNIF 
ORDER BY PERIODO, CODI_EMPRESA,NUMERO_PEDIDO,LINEA_PEDIDO