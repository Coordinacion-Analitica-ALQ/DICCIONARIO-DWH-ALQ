DECLARE fecha DATE;
SET fecha = PARSE_DATE("%Y/%m/%d", CONCAT(
    CAST(EXTRACT(YEAR FROM CURRENT_DATE("America/Bogota")) AS STRING),
    '/',
    CASE WHEN LENGTH(CAST(EXTRACT(MONTH FROM CURRENT_DATE("America/Bogota")) AS STRING)) = 1
    THEN CONCAT('0', CAST(EXTRACT(MONTH FROM CURRENT_DATE("America/Bogota")) AS STRING))
    ELSE CAST(EXTRACT(MONTH FROM CURRENT_DATE("America/Bogota")) AS STRING) END,
    '/01'));

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET  FECHA_REQU_PED  = FECHA_FACTURA
WHERE CODI_EMPRESA IN  ('DN', 'GA')
AND TIPO_DOCU='IN'
AND DATE(FORMAT_DATE("%Y/%m/%d", FECHA_FACTURA)) <= fecha
AND PERIODO=${PERIODO};

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET FECHA_REQU_PED=CURRENT_TIMESTAMP() 
WHERE CODI_EMPRESA IN  ('DN', 'GA')
AND TIPO_DOCU='IN'
AND DATE(FORMAT_DATE("%Y/%m/%d", FECHA_FACTURA))>fecha
AND PERIODO=${PERIODO};

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET FECHA_REQU_PED=FECHA_FACTURA
WHERE CODI_EMPRESA IN  ('DN', 'GA')
AND TIPO_DOCU='CR'
AND PERIODO=${PERIODO};

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET FECHA_REQU_PED=P.FECHA_REQUERIDA  
FROM  COMERCIAL.VENTAS_REPORTE_MENSUAL AS M inner join
LOGISTICA.PEDIDOS_vs_DESPACHOS AS P   
on P.CODIGO_CLIENTE=M.CODIGO_CLIENTE
AND P.NUMERO_PEDIDO=M.NUME_INTERNO 
AND P.CODI_ARTEMP=M.CODI_ARTEMP
AND P.PERIODO=M.PERIODO
where  (M.TIPO_DOCU = 'IN')  
AND M.CODI_EMPRESA IN ( 'DN','GA')
AND DATE(FORMAT_DATE("%Y/%m/%d", FECHA_FACTURA))>= fecha
AND P.PERIODO = ${PERIODO};


UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET FECHA_REQU_PED=P.FECHA_REQUERIDA  
from  COMERCIAL.VENTAS_REPORTE_MENSUAL AS M inner join
LOGISTICA.PEDIDOS_vs_DESPACHOS AS P   
on P.CODIGO_CLIENTE=M.CODIGO_CLIENTE
AND P.NUMERO_PEDIDO=M.NUME_INTERNO 
AND P.PERIODO=M.PERIODO
where  (M.TIPO_DOCU = 'IN')  
AND M.CODI_EMPRESA IN ( 'DN','GA')
AND DATE(FORMAT_DATE("%Y/%m/%d", FECHA_FACTURA)) >= fecha
AND P.PERIODO = ${PERIODO}
AND INDICA_KIT=2


UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET FECHA_REQU_PED=FECHA_FACTURA
WHERE CODI_EMPRESA IN  ('DN', 'GA')
AND TIPO_DOCU='IN'
AND (NUMERO_PEDIDO IS  NULL OR NUMERO_PEDIDO='' OR NUMERO_PEDIDO='0000000')
AND DATE(FORMAT_DATE("%Y/%m/%d", FECHA_FACTURA))>fecha
AND PERIODO= ${PERIODO};

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET ID_FECHA_REQ=T.CODIGO
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL AS V INNER JOIN MAESTRO.DIM_TIEMPOS AS T
ON V.PERIODO=T.PERIODO  
AND DATE(FORMAT_DATE("%Y/%m/%d", V.FECHA_REQU_PED)) = DATE(FORMAT_DATE("%Y/%m/%d", T.FECHA))
WHERE V.CODI_EMPRESA IN  ( 'DN','GA')
AND V.PERIODO= ${PERIODO};

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET ID_FECHA =T.CODIGO
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL AS V INNER JOIN MAESTRO.DIM_TIEMPOS AS T
ON V.PERIODO=T.PERIODO  
AND DATE(FORMAT_DATE("%Y/%m/%d", V.FECHA_FACTURA)) = DATE(FORMAT_DATE("%Y/%m/%d", T.FECHA))
WHERE V.CODI_EMPRESA IN  ( 'DN','GA')
AND V.PERIODO= ${PERIODO};
