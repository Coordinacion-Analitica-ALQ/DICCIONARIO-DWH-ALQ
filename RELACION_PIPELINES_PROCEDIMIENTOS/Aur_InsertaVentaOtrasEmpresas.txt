DECLARE periodop INT64 DEFAULT CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 2 DAY)) AS INT64);
DECLARE diap INT64 DEFAULT EXTRACT(DAY FROM CURRENT_DATE("America/Bogota"));


DELETE COMERCIAL.VENTAS_REPORTE_EMPRESAS WHERE PERIODO=periodop;


INSERT INTO COMERCIAL.VENTAS_REPORTE_EMPRESAS	 (CODI_EMPRESA, NUM_INTERNO, CODI_ARTICULO, UNIDAD_BRUTO, LITRO_BRUTO, 
VALOR_BRUTO, CODI_CLIENTE, FECHA_FACTURA, CODI_CANALSUPE, CODI_CANAL,
CODI_DISTRITO, CODI_ZONA, CLIE_DIRE, VALOR_NC, UNID_NC, LITRO_NC, VALOR_DESC, 
VALOR_DEVO, UNID_NETO, VALOR_NETO, LITRO_NETO,  CODI_REGIONAL, 
CODI_CIUDAD,  NUME_INTERNO, CARTERA, PERIODO,  
CODI_BODEGA,  VALOR_OTRAMONE, IVA_OTRAMONE, CODI_CAUSA, IVA, VALOR_UNITARIO, 
TIPO_DOCU, CODI_ESTRUCTURA, CODI_ARTEMP, CODIGO_BODEMP, CODIGO_CLIENTE, 
NUMERO_LEGAL, ID_FECHA, NUMERO_PEDIDO, CODI_SUBCAUSA, CODIGO_CAUSAL, CODIGO_SUBCAUSAL, 
INDICA_KIT, TOT_ARTKIT,  PADRE_KIT, DESCU_ARTICULO, 
VALOR_BRUTOK, VALOR_NCK, VALOR_NETOK, LITRO_BRUTOK, LITRO_NCK, LITRO_NETOK,
CODI_ESTR_COMER,PK_LINEA,LINEA_NUMERO,IMPORTE,BASE ,DESC_POSV,CANTIDAD_BRUTOKIT,CANTIDAD_NCKIT,CANTIDAD_NETOKIT,
TIPO_ARTFISCAL,IVA_FISCAL,IVA_MANDATO,CUENTA_MANDATO,
NOMBRE_CTAMANDATO,CUENTA_FISCAL,NOMBRE_CTAFISCAL,TIPO_ARTMANDATO)
SELECT CODI_EMPRESA, NUM_INTERNO, CODI_ARTICULO, SUM(UNIDAD_BRUTO) UNIDAD_BRUTO, 
SUM(LITRO_BRUTO) LITRO_BRUTO,SUM(VALOR_BRUTO)  VALOR_BRUTO,  CODI_CLIENTE, FECHA_FACTURA, 
CODI_CANALSUPE, CODI_CANAL, CODI_DISTRITO, CODI_ZONA, CLIE_DIRE, SUM(VALOR_NC) VALOR_NC, 
SUM(UNID_NC) UNID_NC, SUM(LITRO_NC) LITRO_NC, SUM(VALOR_DESC) VALOR_DESC,
SUM(VALOR_DEVO) VALOR_DEVO, SUM(UNID_NETO) UNID_NETO, SUM(VALOR_NETO) VALOR_NETO, 
SUM(LITRO_NETO) LITRO_NETO,	CODI_REGIONAL, CODI_CIUDAD,  NUME_INTERNO, 	
SUM(CARTERA) CARTERA, PERIODO, CODI_BODEGA, 
SUM(VALOR_OTRAMONE) VALOR_OTRAMONE, SUM(IVA_OTRAMONE) IVA_OTRAMONE, 
CODI_CAUSA, SUM(IVA) IVA, SUM(VALOR_UNITARIO) VALOR_UNITARIO , 
TIPO_DOCU, CODI_ESTRUCTURA, CODI_ARTEMP, CODIGO_BODEMP, 
CODIGO_CLIENTE, NUMERO_LEGAL, ID_FECHA,NUMERO_PEDIDO , 
CODI_SUBCAUSA,CODIGO_CAUSAL,CODIGO_SUBCAUSAL,
INDICA_KIT,TOT_ARTKIT ,PADRE_KIT ,DESCU_ARTICULO
, SUM(VALOR_BRUTOK) VALOR_BRUTOK, SUM(VALOR_NCK) VALOR_NCK, SUM(VALOR_NETOK) VALOR_NETOK,
SUM(LITRO_BRUTOK) LITRO_BRUTOK, SUM(LITRO_NCK) LITRO_NCK, SUM(LITRO_NETOK) LITRO_NETOK  ,
CODI_ESTR_COMER,PK_LINEA,LINEA_NUMERO,0,0,sum(DESC_POSV) DESC_POSV,
CANTIDAD_BRUTOKIT,CANTIDAD_NCKIT,CANTIDAD_NETOKIT 
,TIPO_ARTFISCAL,IVA_FISCAL,IVA_MANDATO,CUENTA_MANDATO,
NOMBRE_CTAMANDATO,CUENTA_FISCAL,NOMBRE_CTAFISCAL,TIPO_ARTMANDATO
FROM  COMERCIAL.VENTAS_REPORTE_MENSUAL  
WHERE  PERIODO=CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64)
AND CAST(FORMAT_DATE("%Y/%m/%d", FECHA_FACTURA) AS STRING) <= CAST(FORMAT_DATE("%Y/%m/%d", DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS STRING)
AND CODI_EMPRESA NOT  IN ('DN','GA') 
and    (CODIGO_SUBCAUSAL IS not NULL OR CODIGO_SUBCAUSAL<> 0)
and CODI_ARTICULO<>'99'
GROUP BY CODI_EMPRESA, NUM_INTERNO, CODI_ARTICULO,CODI_CLIENTE, FECHA_FACTURA, 
CODI_CANALSUPE, CODI_CANAL, CODI_DISTRITO, CODI_ZONA, CLIE_DIRE,CODI_REGIONAL, 
CODI_CIUDAD,  NUME_INTERNO,PERIODO, CODI_BODEGA, ANO,CODI_CAUSA,
TIPO_DOCU, CODI_ESTRUCTURA, CODI_ARTEMP, CODIGO_BODEMP, 
CODIGO_CLIENTE, NUMERO_LEGAL, ID_FECHA,NUMERO_PEDIDO , CODI_SUBCAUSA,
CODIGO_CAUSAL,CODIGO_SUBCAUSAL,FECHA_REQU_PED,ID_FECHA_REQ,
INDICA_KIT,TOT_ARTKIT ,PADRE_KIT ,DESCU_ARTICULO,
CODI_ESTR_COMER,PK_LINEA,LINEA_NUMERO,CANTIDAD_BRUTOKIT,CANTIDAD_NCKIT,CANTIDAD_NETOKIT 
,TIPO_ARTFISCAL,IVA_FISCAL,IVA_MANDATO,CUENTA_MANDATO,
NOMBRE_CTAMANDATO,CUENTA_FISCAL,NOMBRE_CTAFISCAL,TIPO_ARTMANDATO;
