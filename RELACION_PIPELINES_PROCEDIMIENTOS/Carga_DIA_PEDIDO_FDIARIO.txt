SELECT FN.PERIODO() AS PERIODO;

TRUNCATE TABLE LOGISTICA.PEDIDOS_vs_DESPACHOS_DIA;

INSERT INTO LOGISTICA.PEDIDOS_vs_DESPACHOS_DIA
( PERIODO, CODI_EMPRESA, FECHA_REQUERIDA, CODI_CLIENTE, SECUENCIA, CODI_ARTICULO, CODIGO_CLIENTE, 
CODI_ARTEMP, ID_FECHA_REQUERIDA, CODI_ESTRUCTURA, NOVEDAD, CODIGO_NOVEDAD, ESTADO_PEDIDO, 
ID_MODIFICADO, NUMERO_PEDIDO, LINEA_PEDIDO, FACTOR, CANTIDAD_PEDIDO, CANTIDAD_DESPACHO, CANTIDAD_NUEVA, LITRO_PEDIDO, LITRO_DESPACHADO, 
DIFERENCIA, LITRO_PEDINUEV, ESTADO_PEDIDO_FIN,FECHA_PEDIDO,ORIGEN_PEDIDO,CODI_ESTADO_LINEA, CODI_ESTADO_PEDIDO, PK_CANCELA,CODIGO_CTROTUNIF)
SELECT DISTINCT  P.PERIODO, C.CODI_EMPRESA, TIMESTAMP(CURRENT_DATE("America/Bogota")) AS FECHA_REQUERIDA, 
P.CODI_CLIENTE, P.SECUENCIA, 
K.CODI_ARTICULO,C.CODIGO CODIGO_CLIENTE,K.CODIGO CODI_ARTEMP,0 ID_FECHA_REQUERIDA,0 CODI_ESTRUCTURA, N.NOVEDAD, 
CODIGO_NOVEDAD, P.ESTADO_PEDIDO ESTADO_PEDIDO, M.ID_MODIFICADO , NUMERO_PEDIDO, LINEA_PEDIDO, 
CAST(FACTOR AS NUMERIC), CAST(CANTIDAD_PEDIDO AS NUMERIC), 
CAST(CANTIDAD_DESPACHO AS NUMERIC), CAST(CANTIDAD_NUEVA AS NUMERIC), CAST(LITRO_PEDIDO AS NUMERIC), CAST(LITRO_DESPACHO AS NUMERIC), 
CAST(DIFERENCIA AS NUMERIC), CAST(LITRO_PEDINUEV AS NUMERIC), P.ESTADO_PEDIDO_TOTAL, TIMESTAMP(CURRENT_DATE("America/Bogota")) AS FECHA_PEDIDO,ORIGEN_PEDIDO,
CASE WHEN P.ESTADO_PEDIDO='C' THEN 3 ELSE
CASE WHEN P.ESTADO_PEDIDO=  'X'  THEN 2  ELSE 1 END END AS CODI_ESTADO_LINEA,
CASE WHEN P.ESTADO_PEDIDO_TOTAL='C' THEN 3 ELSE   2 END CODI_ESTADO_PEDIDO ,P.PK_CAUSA, P.CODIGO_CTROTUNIFICADO
FROM LOGISTICA.PEDIDOS_vs_DESPACHOS_MES AS P INNER JOIN  MAESTRO.DIM_MODIFICADO AS M on 
P.MODIFICADO=M.CODI_MODIFICADO 
INNER JOIN MAESTRO.DIM_NOVEDAD AS N ON P.CODIGO_NOVEDAD=N.IDX_NOVEDAD	  
INNER JOIN MAESTRO.CLIENTES AS C ON P.CODI_EMPRESA=C.CODI_EMPRESA AND P.CODI_CLIENTE=C.CODI_CLIENTE AND P.SECUENCIA=C.DIRE_ENTREGA
INNER JOIN MAESTRO.JERARQUIA_PRODUCTO AS K ON K.CODI_EMPRESA=P.CODI_EMPRESA AND K.CODI_ARTICULO=P.CODI_ARTICULO
WHERE P.PERIODO=1
ORDER BY PERIODO,C.CODI_EMPRESA,ID_FECHA_REQUERIDA,NUMERO_PEDIDO,LINEA_PEDIDO, CODIGO_CLIENTE,CODI_ARTEMP;