DECLARE DIA_LINEAL NUMERIC;
SET DIA_LINEAL = (  SELECT CASE WHEN SUM(PESO_DIA)>0 THEN SUM(PESO_DIA) else 1 end 
                    FROM MAESTRO.DIM_TIEMPOS
                    WHERE PERIODO=CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64)
                    AND FORMAT_DATE("%Y/%m/%d",DATE(FECHA)) <= FORMAT_DATE("%Y/%m/%d", CURRENT_DATE("America/Bogota"))
                 );

INSERT INTO MAESTRO.DATOS_CAMBIOMANO
(PERIODO,CODIGO_CLIENTE, CODI_ARTEMP, CODIGO_CAUSAL, NOMBRE_CAUSAL, CODIGO_SUBCAUSA,  NOMBRE_SUBCAUSAL,DESCRIPCION,
LITRO_NETO, VALOR_NETO, LITRO_NC, VALOR_NC,VALOR_FACTURADO,VALOR_PROYECCION,LITRO_PROYECCION,FACTURADO_PROYECCION,
PROYECCION_NOTAC, PROYECCION_NOTAC_LITRO,CANTIDAD_PEDIDO,
CANTIFDAD_DESPACHO,LITRO_PEDIDO,LITRO_DESPACHADO,VALOR_CAMBIO,PROYECCION_CAMBIOLITRO,PROYECCION_CAMBIOPESO) 

SELECT Ventas.PERIODO AS PERIODO,
Ventas.CODIGO_CLIENTE AS CODIGO_CLIENTE, Ventas.CODI_ARTEMP AS CODI_ARTEMP,	substring(Ventas.CODI_CAUSA,1,2)   AS CODIGO_CAUSAL,
CASE WHEN Ventas.CODI_CAUSA='X' THEN 'DEVOLUCION' ELSE 'OTROS' END AS NOMBRE_CAUSAL,
Ventas.CODIGO_SUBCAUSAL  AS CODIGO_SUBCAUSA, Substring(SubCausal.DESC_DEFINICION,1,100) AS NOMBRE_SUBCAUSAL,'VENTAS' AS  DESCRIPCION,
sum(Ventas.LITRO_NETO) AS LITRO_NETO,
sum(Ventas.VALOR_NETO) AS VALOR_NETO,	
case when Ventas.CODI_CAUSA='X' THEN SUM(Ventas.LITRO_NC) ELSE 0 END AS LITRO_NC,	
case when Ventas.CODI_CAUSA='X' THEN  sum(Ventas.VALOR_NC) ELSE 0 END AS VALOR_NC,	
sum(VALOR_FACTURADO) AS VALOR_FACTURADO,
CASE WHEN (DIAS_LINEAL IS NOT NULL OR  DIAS_LINEAL >0)  THEN CAST(sum(VALOR_NETO/ DIA_LINEAL) * DIAS_TOT_MES AS NUMERIC) ELSE 0 END AS VALOR_PROYECCION,
CASE WHEN (DIAS_LINEAL IS NOT NULL OR  DIAS_LINEAL >0)  THEN CAST(sum( LITRO_NETO/ DIA_LINEAL)* DIAS_TOT_MES AS NUMERIC) ELSE 0 END  AS LITRO_PROYECCION,
CASE WHEN (DIAS_LINEAL IS NOT NULL OR  DIAS_LINEAL >0)  THEN CAST(sum( VALOR_FACTURADO/DIA_LINEAL)*DIAS_TOT_MES AS NUMERIC) ELSE 0 END  AS FACTURADO_PROYECCION,
case when Ventas.CODI_CAUSA='X' THEN  CAST((sum(Ventas.VALOR_NC)/DIA_LINEAL)*DIAS_TOT_MES AS NUMERIC) ELSE 0 END AS PROYECCION_NOTAC,
case when Ventas.CODI_CAUSA='X'  THEN CAST(( sum(Ventas.LITRO_NC)/DIA_LINEAL)*DIAS_TOT_MES AS NUMERIC) ELSE 0 END AS PROYECCION_NOTAC_lITRO,
0 AS CANTIDAD_PEDIDO,    0 AS CANTIFDAD_DESPACHO,    0 AS LITRO_PEDIDO,    0 AS LITRO_DESPACHADO,0 AS VALOR_CAMBIO,
0 AS PROYECCION_CAMBIOLITRO, 0 AS PROYECCION_CAMBIOPESO
FROM COMERCIAL.VENTA_INDICADORES_TOTALFK AS Ventas INNER JOIN 
MAESTRO.DIM_SUBCAUSALES AS SubCausal ON Ventas.CODIGO_SUBCAUSAL = SubCausal.CODIGO
WHERE (Ventas.PERIODO=CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64))
GROUP BY Ventas.PERIODO, Ventas.CODIGO_CLIENTE, Ventas.CODI_ARTEMP, Ventas.CODI_CAUSA,   Ventas.CODIGO_SUBCAUSAL, SubCausal.DESC_DEFINICION,DIAS_LINEAL,DIAS_TOT_MES