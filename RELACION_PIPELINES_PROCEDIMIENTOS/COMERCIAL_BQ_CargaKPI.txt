TRUNCATE TABLE  COMERCIAL.TAB_DATOKPI

INSERT INTO COMERCIAL.TAB_DATOKPI
SELECT DATE(CAST((VENTA_INDICADORES_TOTALFK.PERIODO-10000)/100+2000 AS INT64),MOD(VENTA_INDICADORES_TOTALFK.PERIODO,100),1) AS C_Date2,
    CASE WHEN TIPO_DOCU='IN' AND VENTA_INDICADORES_TOTALFK.VALOR_NETO>0  THEN
      CASE WHEN CODI_CANALSUPE IN ('SM','ST','IN','HR','ID')
         THEN CAST(CODIGO_SECUENCIA AS STRING )
      ELSE
         CASE NOMBRE_REGIONAL WHEN 'REGIONAL ESTE'
            THEN CODI_CLIENTE
         ELSE CAST(CODIGO_SECUENCIA AS STRING)
         END
      END
    END AS CODIGO_CLIENTE,
    CASE WHEN CODI_CANALSUPE IN ('SM','ST','IN','HR','ID')
         THEN CAST(CODIGO_SECUENCIA AS STRING)
      ELSE
         CASE NOMBRE_REGIONAL WHEN 'REGIONAL ESTE'
            THEN CODI_CLIENTE
         ELSE CAST(CODIGO_SECUENCIA AS STRING)
         END
    END AS Codigo_Secuencia_Agrupado,
    CODIGO_SECUENCIA AS Codigo_Secuencia,
    CASE WHEN TIPO_DOCU='IN' AND VENTA_INDICADORES_TOTALFK.VALOR_NETO>0 THEN VENTA_INDICADORES_TOTALFK.NUM_INTERNO END AS NUM_INTERNO,
    VENTA_INDICADORES_TOTALFK.CODI_CAUSA AS CODI_CAUSA,
    VENTA_INDICADORES_TOTALFK.CODI_ESTRUCUTRA AS CODI_ESTRUCTURA,
    VENTA_INDICADORES_TOTALFK.LITRO_NETO  AS LITRO_NETO,
    VENTA_INDICADORES_TOTALFK.VALOR_NETO AS VALOR_NETO,
    VENTA_INDICADORES_TOTALFK.LITRO_NC AS LITRO_NC,
    VENTA_INDICADORES_TOTALFK.VALOR_NC AS VALOR_NC,
    VENTA_INDICADORES_TOTALFK.VALOR_FACTURADO AS Valor_Facturado,


    INDI_Producto.NOMBRE_NEGOCIO AS NOMBRE_NEGOCIO,
    UPPER(INDI_Producto.DESC_GRUPO) AS DESC_GRUPO,
    UPPER(INDI_Producto.DESC_SUBGRUPO) AS DESC_SUBGRUPO,
    INDI_Producto.DESC_PRESENTACION AS DESC_PRESENTACION,
    INDI_Producto.DESC_TAMANO AS DESC_TAMANO,
    INDI_Producto.NOMBRE_MARCA AS NOMBRE_MARCA,
    INDI_Producto.PRESENTACION_TAMANO AS PRESENTACION_TAMANO,
    INDI_Producto.OFERTA_ARTICULO AS OFERTA_ARTICULO,  
    INDI_Producto.NOMBRE_EMP_PRODUC AS Empresa_Productora,
    INDI_Producto.CATEGORIA_COMERCIAL AS Categoria_Comercial,
    INDI_Producto.CATEGORIA_COMERCIAL_MODERNO AS Categoria_Comercial_SM,
    CASE TIPO_DOCU WHEN 'IN' THEN CODIGO_VENDEDOR END AS CODIGO_VENDEDOR,
    CASE WHEN INDI_Clientes.CODI_CANALASOC IN ('SM','ST','FS','BB') THEN INDI_Clientes.NOMBRE_PADRE END AS NOMBRE_PADRE,
    LTRIM(REPLACE(INDI_Clientes.NOMBRE_REGIONAL,'REGIONAL ','')) AS NOMBRE_REGIONAL,
    INDI_Clientes.NOMBRE_REGION AS NOMBRE_REGION,
    CASE WHEN (CODIGO_MAQUILA IS NULL) OR (CODIGO_MAQUILA='MN') OR (CODIGO_MAQUILA='MP') THEN INDI_Clientes.NOMBRE_CANALASOC ELSE 'MAQUILA' END AS NOMBRE_CANALASOC,
    CASE WHEN (CODIGO_MAQUILA IS NULL) OR (CODIGO_MAQUILA='MN') OR (CODIGO_MAQUILA='MP') THEN INDI_Clientes.NOMBRE_CANALSUPE ELSE 'MAQUILA' END AS NOMBRE_CANALSUPE,
    CASE WHEN (CODIGO_MAQUILA IS NULL) OR (CODIGO_MAQUILA='MN') OR (CODIGO_MAQUILA='MP') THEN UPPER(INDI_Clientes.NOMBRE_CANAL) ELSE 'MAQUILA' END AS NOMBRE_CANAL,
    CASE WHEN INDI_Clientes.CODI_CANALASOC IN ('SM','ST','FS','TT','BB')  THEN INDI_Clientes.NOMBRE_TIPOLOGIA END AS NOMBRE_TIPOLOGIA,
    INDI_Clientes.SEGMENTACION AS SEGMENTACION,
    INDI_Clientes.CODI_DISTRITO AS CODI_DISTRITO,
    INDI_Clientes.CODI_ZONA AS CODI_ZONA,
    INDI_Clientes.SEGMENTACION_LECHE AS Cod_Seg_Leche,
    INDI_Clientes.SEGMENTACION_YOGUR AS Cod_Seg_Yogurt,
    INDI_Clientes.NOMBRE_SEGMENTA_LECHE AS Nombre_Seg_Leche,
    INDI_Clientes.NOMBRE_SEGMENTA_YOGUR AS Nombre_Seg_Yogurt,
    REGIONAL_SUPERIOR AS Regional_Superior,
    NULL AS NOMBRE_DISTRITO_DASA,
    NULL AS NOMBRE_ZONA_DASA,
    SECTOR AS Sector,
    CASE FORMATO_SM WHEN 'NO APLICA' THEN NULL ELSE FORMATO_SM END AS FORMATO_SM,
    CASE TIPO_DOCU WHEN 'IN' THEN INDI_Clientes.FRECUENCIA_VISITA END AS FRECUENCIA_VISITA,
    CASE RAZON_SOCIAL WHEN '' THEN NOMB_CLIENTE ELSE IFNULL(RAZON_SOCIAL,NOMB_CLIENTE) END  AS RAZON_SOCIAL,
    CASE TIPO_DOCU WHEN 'IN' THEN INDI_Clientes.DIA_VISITA END AS DIA_VISITA,
    VENTA_INDICADORES_TOTALFK.DIAS_TOT_MES AS DIAS_HABILES,
    DATE(CAST((DIAS2.PERIODO-10000)/100+2000 AS INT64),MOD(DIAS2.PERIODO,100),1) AS FECHA_MAX,
    IFNULL(VENTA_INDICADORES_TOTALFK.DIAS_LINEAL,DIAS_TOT_MES) AS PESO_DIA,
    VENTA_INDICADORES_TOTALFK.VALOR_BRUTO AS Valor_Bruto,
    VENTA_INDICADORES_TOTALFK.CARTERA AS Valor_Dto_Cartera,
    VENTA_INDICADORES_TOTALFK.VALOR_DESC AS Valor_Dto_Negociado,
    VENTA_INDICADORES_TOTALFK.DESC_POSV AS Valor_Dto_POS_Venta,
    VENTA_INDICADORES_TOTALFK.VALOR_DEVO AS Valor_Devolucion_Negociado,
    VENTA_INDICADORES_TOTALFK.UNID_NETO AS Cantidad_neta,
    VENTA_INDICADORES_TOTALFK.UNIDAD_BRUTO AS Cantidad_Bruta,
    VENTA_INDICADORES_TOTALFK.UNID_NC AS Cantidad_Nota_Credito

  FROM COMERCIAL.VENTA_INDICADORES_TOTALFK VENTA_INDICADORES_TOTALFK
    INNER JOIN MAESTRO.INDI_Producto INDI_Producto ON (VENTA_INDICADORES_TOTALFK.CODI_ARTEMP = INDI_Producto.CODI_ARTEMP)
    INNER JOIN MAESTRO.INDI_Clientes INDI_Clientes ON (VENTA_INDICADORES_TOTALFK.CODIGO_CLIENTE = INDI_Clientes.CODIGO_CLIENTE)
    INNER JOIN (SELECT PERIODO_DIASH.PERIODO, 1 AS CLAVE FROM COMERCIAL.PERIODO_DIASH ORDER BY PERIODO_DIASH.PERIODO DESC LIMIT 1) DIAS2 ON 1=DIAS2.CLAVE

WHERE VENTA_INDICADORES_TOTALFK.PERIODO= ${PERIODO} AND INDI_Clientes.NOMBRE_REGIONAL IN (${NOMBRE_REGIONAL})