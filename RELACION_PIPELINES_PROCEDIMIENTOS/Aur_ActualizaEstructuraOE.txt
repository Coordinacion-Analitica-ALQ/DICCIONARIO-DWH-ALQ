DECLARE periodop INT64 DEFAULT CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);
DECLARE valorp NUMERIC;


--*****************************************************
--1.ACTUALIZA LA ESTRUCTURA  DEL CLIENTE EN  
--LA TABLA VENTAS_REPORTE_MENSUAL PARA OBTENER EL HISTORICO

update COMERCIAL.VENTAS_REPORTE_MENSUAL
SET CODIGO_CLIENTE=C.CODIGO
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL V INNER JOIN  MAESTRO.CLIENTES AS C 
on  V.CODI_EMPRESA=C.CODI_EMPRESA
AND V.CODI_CLIENTE=C.CODI_CLIENTE
AND V.CLIE_DIRE=C.DIRE_ENTREGA
where V.PERIODO=periodop
AND C.CODI_EMPRESA IN ('MK','HC','SM','EP','CD' ,'PO','GI','AR','PL','NC','AF' , 'KZ');

--2.ACTUALIZA LA ESTRUCTURA  DEL PRODUCTO EN  LA TABLA VENTAS_REPORTE_MENSUAL 

update COMERCIAL.VENTAS_REPORTE_MENSUAL
SET  CODI_ARTEMP=C.CODIGO
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL AS V  inner join MAESTRO.JERARQUIA_PRODUCTO AS C 
on   V.CODI_EMPRESA=C.CODI_EMPRESA
AND V.CODI_ARTICULO=C.CODI_ARTICULO
where V.PERIODO=periodop
AND C.CODI_EMPRESA IN ('MK','HC','SM','EP','CD' ,'PO','GI','AR','PL','NC','AF' , 'KZ');

--3.ACTUALIZA EL CODIGO DE LA FECHA EN  LA TABLA VENTAS_REPORTE_MENSUAL 

update COMERCIAL.VENTAS_REPORTE_MENSUAL
SET  ID_FECHA=C.CODIGO
,ID_FECHA_REQ=C.CODIGO
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL AS V   inner join MAESTRO.DIM_TIEMPOS AS C 
ON CAST(FORMAT_DATE("%Y/%m/%d",V.FECHA_FACTURA) AS STRING) = CAST(FORMAT_DATE("%Y/%m/%d",C.FECHA)  AS STRING)
AND V.PERIODO=C.PERIODO
where V.PERIODO=periodop
AND V.CODI_EMPRESA IN ('MK','HC','SM','EP','CD' ,'PO','GI','AR','PL','NC','AF' , 'KZ');

    
--4.actualiza codigo causa que son 0 o blanco

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET CODI_CAUSA=  '99'
where (CODI_CAUSA is null or CODI_CAUSA='' or CODI_CAUSA=' ')
AND PERIODO=periodop
AND CODI_EMPRESA IN ('MK','HC','SM','EP','CD' ,'PO','GI','AR','PL','NC','AF' , 'KZ');


--5.actualiza codigo causa q

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET CODIGO_CAUSAL=  C.CODIGO
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL AS V  inner join MAESTRO.DIM_CAUSALES AS C
on  V.CODI_EMPRESA=C.CODI_EMPRESA
AND LTRIM(rtrim(V.CODI_CAUSA))=LTRIM(RTRIM(C.CODI_DEFINICION))
where  V.PERIODO=periodop
AND V.CODI_EMPRESA IN  ('MK','HC','SM','EP','CD' ,'PO','GI','AR','PL','NC','AF' , 'KZ');


--6. actu7aliza los codigos de causa cuando son nulos o blancos con 99

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET CODI_SUBCAUSA='99'
WHERE (CODI_SUBCAUSA='' OR CODI_SUBCAUSA IS NULL   or  CODI_SUBCAUSA=' ')
AND PERIODO=periodop
AND CODI_EMPRESA IN ('MK','HC','SM','EP','CD' ,'PO','GI','AR','PL','NC','AF' , 'KZ');




--7. actualiza con el primary key del codigo de subcausales

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL
SET CODIGO_SUBCAUSAL=  C.CODIGO  
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL AS V inner join MAESTRO.DIM_SUBCAUSALES AS C
on V.CODI_EMPRESA=C.CODI_EMPRESA
AND LTRIM(rtrim(V.CODI_SUBCAUSA))=LTRIM(RTRIM(C.CODI_DEFINICION))
where  V.PERIODO=periodop
AND V.CODI_EMPRESA IN ('MK','HC','SM','EP','CD' ,'PO','GI','AR','PL','NC','AF' , 'KZ');

