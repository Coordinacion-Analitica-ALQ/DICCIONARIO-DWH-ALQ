SELECT FN.PERIODO() AS PERIODO;

MERGE MAESTRO.TABLA_KITS AS K 
USING(SELECT 'FK' CODI_EMPRESA,CODI_KITFK,T.CODI_ARTICULO,CANTIDAD,CURRENT_TIMESTAMP() AS FECHA,
12105 AS PERIODO, P.CODIGO AS CODI_ARTEMP
FROM MAESTRO.TABLA_KITSFK AS T LEFT OUTER JOIN MAESTRO.JERARQUIA_PRODUCTO AS P
ON T.CODI_KITFK=P.CODI_ARTICULO  AND P.CODI_EMPRESA='FK') AS C
on K.CODI_EMPRESA=C.CODI_EMPRESA
AND K.CODI_KIT=C.CODI_KITFK
AND K.CODI_ARTICULO=C.CODI_ARTICULO
WHEN MATCHED THEN
UPDATE SET CANTIDAD=C.CANTIDAD
WHEN NOT MATCHED THEN
INSERT  (CODI_EMPRESA, CODI_KIT, CODI_ARTICULO, CANTIDAD, FECHA_CREACION,
PERIODO, CODI_ARTEMP, TIPO)
VALUES (CODI_EMPRESA,CODI_KITFK,C.CODI_ARTICULO,C.CANTIDAD,C.FECHA,
C.PERIODO,C.CODI_ARTEMP,'K');

UPDATE MAESTRO.TABLA_KITSFK AS F
SET CODI_EQUIVAL=E.CODI_ARTICULO,
CODI_EMPRESA='FK'
FROM MAESTRO.FK_EQUIVALENCIAS AS E
WHERE F.CODI_ARTICULO=E.CODI_ARTICULO_FK;