SELECT MAX(CODIGO) AS CODIGO FROM PRUEBAS.CLIENTES_TRIM;

UPDATE MAESTRO.CLIENTES AS C
SET CODI_UNIDAD=COALESCE (P.REGIONAL,'99'),
	CODI_REGION= COALESCE (P.CODI_REGION,'99'),
	CODI_CANALSUPE= COALESCE (P.CODI_CANALSUPE,'99'), 
	CODI_CANAL=  COALESCE (P.CODI_CANAL,'99'),  
	CODI_DISTRITO=  COALESCE (P.CODI_DISTRITO,'99'),  
	CODI_ZONA=  COALESCE (P.CODI_ZONA,'99'),  
	CODI_CIUDAD=  COALESCE (P.CODI_CIUDAD,'99'), 
	ESTRATO_CLIENTE=  COALESCE (P.ESTRATO,'99'), 
	NOMB_CLIENTE=  COALESCE (P.NOMB_CLIENTE,''),
	DIRE_CLIENTE= P.DIRE_CLIENTE,
	TIPO_CLIENTE= COALESCE (P.TIPO_CLIENTE,''),
	TELE_CLIENTE= P.TELE_CLIENTE,
	NIT=P.NIT,
	TIPOLOGIA=  COALESCE (P.TIPOLOGIA,'99'),  
	RAZON_SOCIAL=P.RAZON_SOCIAL,
	BODEGA_DESPACHO= COALESCE (P.BODEGA,'99'),
	FECHA_CREACION=P.FECHA_CREACION,
	COORDENADA_X=P.COORDENADA_X,
	COORDENADA_Y=P.COORDENADA_Y,
	CODIGO_ANTERIOR=P.CODIGO_ANTERIOR,
	CODIGO_SECUENCIA=CONCAT(TRIM(P.CODI_CLIENTE) ,'  -', TRIM(P.DIRE_ENTREGA))				
FROM (
	-- limpieza de espacios en clientes_temp
	SELECT * REPLACE(
		TRIM(CODI_EMPRESA) AS CODI_EMPRESA,
		TRIM(CODI_CLIENTE) AS CODI_CLIENTE,
		TRIM(NOMB_CLIENTE) AS NOMB_CLIENTE,
		TRIM(DIRE_CLIENTE) AS DIRE_CLIENTE,
		TRIM(CIUD_CLIENTE) AS CIUD_CLIENTE,
		TRIM(TIPO_CLIENTE) AS TIPO_CLIENTE,
		TRIM(CODI_CANALSUPE) AS CODI_CANALSUPE,
		TRIM(CODI_CANAL) AS CODI_CANAL,
		TRIM(CODI_DISTRITO) AS CODI_DISTRITO,
		TRIM(CODI_ZONA) AS CODI_ZONA,
		TRIM(TELE_CLIENTE) AS TELE_CLIENTE,
		TRIM(NIT) AS NIT,
		TRIM(CODI_REGION) AS CODI_REGION,
		TRIM(CODI_CIUDAD) AS CODI_CIUDAD,
		TRIM(DIRE_ENTREGA) AS DIRE_ENTREGA,
		TRIM(TIPOLOGIA) AS TIPOLOGIA,
		TRIM(ESTRATO) AS ESTRATO,
		TRIM(RAZON_SOCIAL) AS RAZON_SOCIAL,
		TRIM(BODEGA) AS BODEGA,
		TRIM(REGIONAL) AS REGIONAL,
		CAST(PARSE_DATE("%Y%m%d", CAST(FECHA_CREACION + 19000000 AS STRING)) AS TIMESTAMP)  AS FECHA_CREACION,
		TRIM(COORDENADA_X) AS COORDENADA_X,
		TRIM(COORDENADA_Y) AS COORDENADA_Y,
		TRIM(CODIGO_ANTERIOR) AS CODIGO_ANTERIOR
	) 
	FROM MAESTRO.CLIENTES_TEMP
) P
WHERE P.CODI_EMPRESA=C.CODI_EMPRESA 
	AND P.CODI_CLIENTE=C.CODI_CLIENTE
	AND P.DIRE_ENTREGA=C.DIRE_ENTREGA
;


INSERT INTO MAESTRO.CLIENTES (
 CODIGO, CODI_EMPRESA, CODI_UNIDAD,
 CODI_CLIENTE, DIRE_ENTREGA, CODI_CANALSUPE, CODI_CANAL,
 CODI_DISTRITO, CODI_ZONA, CODI_CIUDAD, CODI_REGION,
 NOMB_CLIENTE, DIRE_CLIENTE, CIUD_CLIENTE,
 TELE_CLIENTE, NIT, TIPO_CLIENTE, TIPOLOGIA, CODIGO_SECUENCIA,
 ESTRATO_CLIENTE, RAZON_SOCIAL, FECHA_CREACION,
 COORDENADA_X, COORDENADA_Y, CODIGO_ANTERIOR
)
-- registros para insertar
SELECT ${CODIGO} + ROW_NUMBER() OVER () AS CODIGO,
  P.CODI_EMPRESA, P.REGIONAL,
  P.CODI_CLIENTE, P.DIRE_ENTREGA, P.CODI_CANALSUPE, P.CODI_CANAL,
  P.CODI_DISTRITO, P.CODI_ZONA, P.CODI_CIUDAD, P.CODI_REGION,
  P.NOMB_CLIENTE, P.DIRE_CLIENTE, P.CIUD_CLIENTE,
  P.TELE_CLIENTE, P.NIT, P.TIPO_CLIENTE, P.TIPOLOGIA,
  CONCAT(TRIM(P.CODI_CLIENTE) ,'  -', TRIM(P.DIRE_ENTREGA)) CODIGO_SECUENCIA,
  P.ESTRATO, P.RAZON_SOCIAL, P.FECHA_CREACION,
  P.COORDENADA_X, P.COORDENADA_Y, P.CODIGO_ANTERIOR
FROM ( 
	-- limpieza de espacios en clientes_temp
	SELECT * REPLACE(
		TRIM(CODI_EMPRESA) AS CODI_EMPRESA,
		TRIM(CODI_CLIENTE) AS CODI_CLIENTE,
		TRIM(NOMB_CLIENTE) AS NOMB_CLIENTE,
		TRIM(DIRE_CLIENTE) AS DIRE_CLIENTE,
		TRIM(CIUD_CLIENTE) AS CIUD_CLIENTE,
		TRIM(TIPO_CLIENTE) AS TIPO_CLIENTE,
		TRIM(CODI_CANALSUPE) AS CODI_CANALSUPE,
		TRIM(CODI_CANAL) AS CODI_CANAL,
		TRIM(CODI_DISTRITO) AS CODI_DISTRITO,
		TRIM(CODI_ZONA) AS CODI_ZONA,
		TRIM(TELE_CLIENTE) AS TELE_CLIENTE,
		TRIM(NIT) AS NIT,
		TRIM(CODI_REGION) AS CODI_REGION,
		TRIM(CODI_CIUDAD) AS CODI_CIUDAD,
		TRIM(DIRE_ENTREGA) AS DIRE_ENTREGA,
		TRIM(TIPOLOGIA) AS TIPOLOGIA,
		TRIM(ESTRATO) AS ESTRATO,
		TRIM(RAZON_SOCIAL) AS RAZON_SOCIAL,
		TRIM(BODEGA) AS BODEGA,
		TRIM(REGIONAL) AS REGIONAL,
		CAST(PARSE_DATE("%Y%m%d", CAST(FECHA_CREACION + 19000000 AS STRING)) AS TIMESTAMP)  AS FECHA_CREACION,
		TRIM(COORDENADA_X) AS COORDENADA_X,
		TRIM(COORDENADA_Y) AS COORDENADA_Y,
		TRIM(CODIGO_ANTERIOR) AS CODIGO_ANTERIOR
	) 
	FROM MAESTRO.CLIENTES_TEMP
) AS P
  LEFT JOIN MAESTRO.CLIENTES C
    ON P.CODI_EMPRESA=C.CODI_EMPRESA 
      AND P.CODI_CLIENTE=C.CODI_CLIENTE
      AND P.DIRE_ENTREGA=C.DIRE_ENTREGA
WHERE C.CODI_CLIENTE IS NULL
;
