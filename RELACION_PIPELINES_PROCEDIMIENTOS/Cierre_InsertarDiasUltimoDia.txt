SELECT FN.PERIODO() AS PERIODO;

INSERT INTO MAESTRO.DIM_TIEMPOS (CODIGO, FECHA, PERIODO, ANO, MES, DIA, SEMANA, NUM_DIASEMANA, PESO_DIA, FECHA_DIA, FECHA_CORTA, DOMINGO, FESTIVO, NOMBRE_MES)
SELECT CODIGO,TIMESTAMP(FORMAT_DATE("%F", CURRENT_DATE("America/Bogota"))) AS FECHA, 
${PERIODO} AS PERIODO,
EXTRACT(YEAR FROM CURRENT_DATE("America/Bogota")) AS ANO , 
EXTRACT(MONTH FROM CURRENT_DATE("America/Bogota")) AS MES ,
EXTRACT(DAY FROM CURRENT_DATE("America/Bogota")) AS DIA ,
EXTRACT(WEEK FROM CURRENT_DATE("America/Bogota")) AS SEMANA,
EXTRACT(DAYOFWEEK FROM CURRENT_DATE("America/Bogota")) AS NUM_DIASEMANA ,
0 AS PESODIA,
CONCAT(CAST(FORMAT_DATE("1%y%m",CURRENT_DATE("America/Bogota")) AS STRING), '-', CAST(FORMAT_DATE("%Y/%m/%d", CURRENT_DATE("America/Bogota")) AS STRING)) AS  FECHA_DIA,
CAST(FORMAT_DATE("%Y/%m/%d", CURRENT_DATE("America/Bogota")) AS STRING) AS FECHA_CORTA,
0,
0,
''
FROM MAESTRO.DIM_TIEMPOS
WHERE CONCAT(CAST(FORMAT_DATE("%Y/%m/%d", CURRENT_DATE("America/Bogota")) AS STRING), CAST(FORMAT_DATE("1%y%m", CURRENT_DATE("America/Bogota")) AS STRING))
NOT IN 
(
SELECT CONCAT(CAST(FORMAT_DATE("%Y/%m/%d", DATE(FECHA)) AS STRING), CAST(PERIODO AS STRING))
FROM MAESTRO.DIM_TIEMPOS 
WHERE PERIODO = ${PERIODO}
);

UPDATE MAESTRO.DIM_TIEMPOS AS T
SET PESO_DIA = P.PESO_CANATRAD
FROM MAESTRO.TABLA_PROYECCION AS P
WHERE T.PERIODO=P.PERIODO
AND FORMAT_DATE("%Y/%m/%d",DATE(T.FECHA)) = FORMAT_DATE("%Y/%m/%d",DATE(P.FECHA))
AND T.PERIODO= ${PERIODO};

UPDATE MAESTRO.DIM_TIEMPOS
SET NOMBRE_MES = CASE CAST(EXTRACT(MONTH FROM CURRENT_DATE("America/Bogota")) AS INT64)
WHEN 1 THEN 'Enero' 
WHEN 2 THEN 'Febrero' 
WHEN 3 THEN 'Marzo'
WHEN 4 THEN 'Abril'  
WHEN 5 THEN 'Mayo'
WHEN 6 THEN 'Junio'
WHEN 7 THEN 'Julio'  
WHEN 8 THEN 'Agosto'
WHEN 9 THEN 'Septiembre'
WHEN 10 THEN 'Octubre'
WHEN 11 THEN 'Noviembre'
WHEN 12 THEN 'Diciembre' END
WHERE PERIODO= ${PERIODO};

UPDATE MAESTRO.DIASH_REGIONAL AS R
set ID_FECHA=D.CODIGO
FROM MAESTRO.DIM_TIEMPOS  AS D
WHERE R.PERIODO = CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64) AND D.PERIODO=R.PERIODO
AND CAST(FORMAT_DATE("%Y/%m/%d",DATE(D.FECHA)) AS STRING) = CAST(FORMAT_DATE("%Y/%m/%d",DATE(R.FECHA)) AS STRING);