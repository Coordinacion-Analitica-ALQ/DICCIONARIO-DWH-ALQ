DECLARE valor NUMERIC(18,0);
DECLARE mydate DATE DEFAULT CURRENT_DATE("America/Bogota");
DECLARE periodop INT64 DEFAULT CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);
DECLARE ultimodia DATE DEFAULT LAST_DAY(DATE(CURRENT_DATE("America/Bogota")), MONTH);

TRUNCATE TABLE COMERCIAL.VENTAS_REPORTE_MENSUAL_FK;

IF (mydate < ultimodia)
THEN

INSERT INTO COMERCIAL.VENTAS_REPORTE_MENSUAL_FK(
CODI_EMPRESA, NUM_INTERNO, CODI_ARTICULO, UNIDAD_BRUTO, LITRO_BRUTO, 
VALOR_BRUTO,  CODI_CLIENTE, FECHA_FACTURA, CODI_CANALSUPE, 
CODI_CANAL, CODI_DISTRITO, CODI_ZONA, CLIE_DIRE, VALOR_NC, UNID_NC, 
LITRO_NC, VALOR_DESC, VALOR_DEVO, UNID_NETO, VALOR_NETO, LITRO_NETO, 
CODI_REGIONAL, CODI_CIUDAD, NUME_INTERNO, 	 CARTERA, PERIODO, CODI_BODEGA, ANO, 
VALOR_OTRAMONE, IVA_OTRAMONE, CODI_CAUSA, IVA, VALOR_UNITARIO, 
TIPO_ARTFISCAL, TIPO_DOCU, CODI_ESTRUCTURA, CODI_ARTEMP, CODIGO_BODEMP, 
CODIGO_CLIENTE, NUMERO_LEGAL, ID_FECHA, NUMERO_PEDIDO, CODI_SUBCAUSA, 
CODIGO_CAUSAL, CODIGO_SUBCAUSA, COBERTURA, LINEA_NUMERO, FECHA_REQU_PED, 
ID_FECH_REQ, CODI_CANALASOC, INDICA_KIT, TOT_ARTKIT, ARTICULO_HIJO, 
DESCU_ARTICULO, VALOR_BRUTOK, VALOR_NCK, VALOR_NETOK, LITRO_BRUTOK, 
LITRO_NCK, LITRO_NETOK, CODI_ESTR_COMER, PK_LINEA, IMPORTE, BASE,CODIGO_VENDEDOR,CODI_RUTA)

select substring(CODI_EMPRESA,1,2) CODI_EMPRESA, substring( NUM_INTERNO,1,15)  NUM_INTERNO, 
substring(CODI_ARTICULO,1,10) CODI_ARTICULO, UNIDAD_BRUTO,
LITRO_BRUTO, VALOR_BRUTO,  substring(CODI_CLIENTE,1,8) CODI_CLIENTE, 
FECHA_FACTURA, substring(CODI_CANALSUPE,1,2) CODI_CANALSUPE,substring(CODI_CANAL,1,2)  CODI_CANAL,
substring ( CODI_DISTRITO,1,2) CODI_DISTRITO, substring(CODI_ZONA,1,2)  CODI_ZONA,'000' CLIE_DIRE, 
VALOR_NC, UNID_NC, LITRO_NC, VALOR_DESC, VALOR_DEVO, UNID_NETO, 
VALOR_NETO, LITRO_NETO, 	 substring(CODI_REGION,1,3) CODI_REGION, SUBSTRING(CODI_CIUDAD,1,6) CODI_CIUDAD, 
substring( NUM_INTERNO,1,15)  NUME_INTERNO,   CARTERA, PERIODO, ''   CODI_BODEGA,
EXTRACT(YEAR FROM CURRENT_DATE("America/Bogota")) ANO,0  VALOR_OTRAMONE,0 IVA_OTRAMONE, 	 SUBSTRING(CODI_CAUSA,1,2) CODI_CAUSA, IVA,
VALOR_UNITARIO, ''  TIPO_ARTFISCAL, SUBSTRING(TIPO_DOCU,1,2) TIPO_DOCU, 7 CODI_ESTRUCTURA, 
CODI_ARTEMP,0  CODIGO_BODEMP,  CODIGO_CLIENTE, SUBSTRING(NUMERO_LEGAL,1,20) NUMERO_LEGAL, ID_FECHA, 
substring( NUM_INTERNO,1,15)    NUMERO_PEDIDO, 	   SUBSTRING( CODI_SUBCAUSA,1,2) , 
CODIGO_CAUSAL,   CODIGO_SUBCAUSAL,0 COBERTURA,0 LINEA_NUMERO,FECHA_FACTURA FECHA_REQU_PED,ID_FECHA  ID_FECH_REQ, 
CODI_CANALASOC, CAST(INDICA_KIT AS INT64),	 TOT_ARTKIT,'1' ARTICULO_HIJO,0 DESCU_ARTICULO, 
0 VALOR_BRUTOK,0 VALOR_NCK,0 VALOR_NETOK,0 LITRO_BRUTOK, 0 LITRO_NCK,0 LITRO_NETOK, 
0 CODI_ESTR_COMER,0 PK_LINEA, 	0 IMPORTE,0 BASE,
CASE WHEN ( CODI_VENDEDOR IS NULL OR  CODI_VENDEDOR ='')  THEN '99' ELSE SUBSTRING(CODI_VENDEDOR,1,8) END  CODI_VENDEDOR,
CASE WHEN ( CODI_RUTA IS NULL OR  CODI_RUTA ='')  THEN '99' ELSE SUBSTRING(CODI_RUTA,1,10) END  CODI_RUTA
from  COMERCIAL.FK_VENTASA 
WHERE CODI_EMPRESA ='FK' 
AND  CODI_CAUSA NOT IN ('F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'F13', 'F14', 'F15', 'F16', 'F17', 'F18', 'F19', 'F20')
and  PERIODO=periodop
AND CAST(FORMAT_DATE("%Y/%m/%d", FECHA_FACTURA) AS STRING) < CAST(FORMAT_DATE("%Y/%m/%d", CURRENT_DATE("America/Bogota")) AS STRING);

DELETE COMERCIAL.VENTAS_REPORTE_MENSUAL_FK
WHERE CODI_EMPRESA='FK'
AND ( CODIGO_CLIENTE IS NULL OR CODIGO_CLIENTE=0);

END IF;


IF  (mydate = ultimodia)
THEN 

INSERT INTO COMERCIAL.VENTAS_REPORTE_MENSUAL_FK(
CODI_EMPRESA, NUM_INTERNO, CODI_ARTICULO, UNIDAD_BRUTO, LITRO_BRUTO, 
VALOR_BRUTO, CODI_CLIENTE, FECHA_FACTURA, CODI_CANALSUPE, 
CODI_CANAL, CODI_DISTRITO, CODI_ZONA, CLIE_DIRE, VALOR_NC, UNID_NC, 
LITRO_NC, VALOR_DESC, VALOR_DEVO, UNID_NETO, VALOR_NETO, LITRO_NETO, 
CODI_REGIONAL, CODI_CIUDAD, NUME_INTERNO, 	 CARTERA, PERIODO, CODI_BODEGA, ANO, 
VALOR_OTRAMONE, IVA_OTRAMONE, CODI_CAUSA, IVA, VALOR_UNITARIO, 
TIPO_ARTFISCAL, TIPO_DOCU, CODI_ESTRUCTURA, CODI_ARTEMP, CODIGO_BODEMP, 
CODIGO_CLIENTE, NUMERO_LEGAL, ID_FECHA, NUMERO_PEDIDO, CODI_SUBCAUSA, 
CODIGO_CAUSAL, CODIGO_SUBCAUSA, COBERTURA, LINEA_NUMERO, FECHA_REQU_PED, 
ID_FECH_REQ, CODI_CANALASOC, INDICA_KIT, TOT_ARTKIT, ARTICULO_HIJO, 
DESCU_ARTICULO, VALOR_BRUTOK, VALOR_NCK, VALOR_NETOK, LITRO_BRUTOK, 
LITRO_NCK, LITRO_NETOK, CODI_ESTR_COMER, PK_LINEA, IMPORTE, BASE,CODIGO_VENDEDOR,CODI_RUTA)

SELECT substring(CODI_EMPRESA,1,2)CODI_EMPRESA, substring( NUM_INTERNO,1,15)  NUM_INTERNO, 
substring(CODI_ARTICULO,1,10) CODI_ARTICULO, UNIDAD_BRUTO,
LITRO_BRUTO, VALOR_BRUTO,  substring(CODI_CLIENTE,1,8) CODI_CLIENTE, 
FECHA_FACTURA, substring(CODI_CANALSUPE,1,2) CODI_CANALSUPE,substring(CODI_CANAL,1,2)  CODI_CANAL,
substring ( CODI_DISTRITO,1,2) CODI_DISTRITO, substring(CODI_ZONA,1,2)  CODI_ZONA,'000' CLIE_DIRE, 
VALOR_NC, UNID_NC, LITRO_NC, VALOR_DESC, VALOR_DEVO, UNID_NETO, 
VALOR_NETO, LITRO_NETO, 	 substring(CODI_REGION,1,3) CODI_REGION, SUBSTRING(CODI_CIUDAD,1,6) CODI_CIUDAD, 
substring( NUM_INTERNO,1,15)  NUME_INTERNO,   CARTERA, PERIODO, ''   CODI_BODEGA,
EXTRACT(YEAR FROM CURRENT_DATE("America/Bogota")) ANO,0  VALOR_OTRAMONE,0 IVA_OTRAMONE, 	 SUBSTRING(CODI_CAUSA,1,2) CODI_CAUSA, IVA,
VALOR_UNITARIO, ''  TIPO_MANDATO, SUBSTRING(TIPO_DOCU,1,2) TIPO_DOCU, 7 CODI_ESTRUCTURA, 
CODI_ARTEMP,0  CODIGO_BODEMP,  CODIGO_CLIENTE, SUBSTRING(NUMERO_LEGAL,1,20) NUMERO_LEGAL, ID_FECHA, 
substring( NUM_INTERNO,1,15)    NUMERO_PEDIDO, 	   SUBSTRING( CODI_SUBCAUSA,1,2) , 
CODIGO_CAUSAL,   CODIGO_SUBCAUSAL,0 COBERTURA,0 LINEA_NUMERO,FECHA_FACTURA FECHA_REQU_PED,ID_FECHA  ID_FECH_REQ, 
CODI_CANALASOC, CAST(INDICA_KIT AS INT64),	 TOT_ARTKIT,'1' ARTICULO_HIJO,0 DESCU_ARTICULO, 
0 VALOR_BRUTOK,0 VALOR_NCK,0 VALOR_NETOK,0 LITRO_BRUTOK, 0 LITRO_NCK,0 LITRO_NETOK, 
0 CODI_ESTR_COMER,0 PK_LINEA, 	0 IMPORTE,0 BASE,
CASE WHEN ( CODI_VENDEDOR IS NULL OR  CODI_VENDEDOR ='')  THEN '99' ELSE SUBSTRING(CODI_VENDEDOR,1,8) END  CODI_VENDEDOR,
CASE WHEN ( CODI_RUTA IS NULL OR  CODI_RUTA ='')  THEN '99' ELSE SUBSTRING(CODI_RUTA,1,10) END  CODI_RUTA
from  COMERCIAL.FK_VENTASA  	
where CODI_EMPRESA ='FK' 
AND  CODI_CAUSA NOT IN ('F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'F13', 'F14', 'F15', 'F16', 'F17', 'F18', 'F19', 'F20')
and  PERIODO=periodop;

END IF;

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL_FK
SET FECHA_REQU_PED=FECHA_FACTURA
WHERE  PERIODO=periodop
AND CODI_EMPRESA='FK';

UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL_FK
SET ID_FECH_REQ=T.CODIGO
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL_FK AS V INNER JOIN MAESTRO.DIM_TIEMPOS AS T
ON V.PERIODO=T.PERIODO  
AND CAST(FORMAT_DATE("%Y/%m/%d", V.FECHA_REQU_PED) AS STRING) = CAST(FORMAT_DATE("%Y/%m/%d", T.FECHA) AS STRING)
WHERE V.CODI_EMPRESA IN  ( 'FK')
AND V.PERIODO=periodop;


UPDATE COMERCIAL.VENTAS_REPORTE_MENSUAL_FK 
SET CANTIDAD_BRUTOKIT = CASE WHEN  P.FACT_CONVER<>0 THEN (V.LITRO_BRUTO/P.FACT_CONVER) ELSE 0 END,
CANTIDAD_NCKIT=CASE WHEN  P.FACT_CONVER<>0 THEN (V.LITRO_NC/P.FACT_CONVER) ELSE 0 END,
CANTIDAD_NETOKIT=CASE WHEN  P.FACT_CONVER<>0 THEN (V.LITRO_NETO/P.FACT_CONVER) ELSE 0 END
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL_FK AS V INNER JOIN MAESTRO.JERARQUIA_PRODUCTO AS P
ON V.CODI_ARTEMP=P.CODIGO
WHERE V.CODI_EMPRESA IN  ( 'FK');


INSERT INTO MAESTRO.DIANA_AUDITORIA(NOMBRE_TABLA, FECHA, PERIODO, NUMERO_REGISTROS)
SELECT 'VENTAS_REPORTE_MENSUAL_FK',TIMESTAMP(CURRENT_DATE("America/Bogota")), periodop,
COUNT(*) AS  NUM_REGISTRO
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL_FK;