SELECT FN.PERIODO() AS PERIODO;

INSERT INTO MAESTRO.DIM_TIEMPOS
(CODIGO, FECHA, PERIODO, ANO, MES, DIA, SEMANA, NUM_DIASEMANA, PESO_DIA, FECHA_DIA, FECHA_CORTA, DOMINGO, FESTIVO, NOMBRE_MES)
SELECT CODIGO, CURRENT_TIMESTAMP() AS FECHA , 
${PERIODO} AS PERIODO,
EXTRACT(YEAR FROM CURRENT_DATE("America/Bogota")) AS ANO , 
EXTRACT(MONTH FROM CURRENT_DATE("America/Bogota")) AS MES ,
EXTRACT(DAY FROM CURRENT_DATE("America/Bogota")) AS DIA ,
EXTRACT(WEEK FROM CURRENT_DATE("America/Bogota")) AS SEMANA,
EXTRACT(DAYOFWEEK FROM CURRENT_DATE("America/Bogota")) as NUM_DIASEMANA ,
0 AS PESODIA, 
CONCAT(CAST(${PERIODO} AS STRING), '-', CAST(FORMAT_DATE("%Y/%m/%d)",CURRENT_DATE("America/Bogota")) AS STRING)) AS FECHA_DIA,
CAST(FORMAT_DATE("%Y/%m/%d)",CURRENT_DATE("America/Bogota")) AS STRING) FECHA_CORTA,
0,
0,
''
FROM MAESTRO.DIM_TIEMPOS
WHERE CONCAT(CAST(FORMAT_DATE("%Y/%m/%d)",CURRENT_DATE("America/Bogota")) AS STRING), '1', CAST(${PERIODO} AS STRING))
NOT IN 
(
SELECT CONCAT(CAST(FORMAT_DATE("%Y/%m/%d)",DATE(FECHA)) AS STRING), CAST(PERIODO AS STRING))
FROM MAESTRO.DIM_TIEMPOS
WHERE PERIODO = ${PERIODO}
);

UPDATE MAESTRO.DIM_TIEMPOS
SET NOMBRE_MES = CASE EXTRACT(MONTH FROM CURRENT_DATE("America/Bogota"))
WHEN 1 THEN 'Enero' 
WHEN 2 THEN 'Febrero' 
WHEN 3 THEN 'Marzo'
WHEN 4 THEN 'Abril'  
WHEN 5 THEN 'Mayo'
WHEN 6 THEN 'Junio'
WHEN 7 THEN 'Julio'  
WHEN 8 THEN 'Agosto'
WHEN 9 THEN 'Septiembre'
WHEN 10 THEN 'Octubre'
WHEN 11 THEN 'Noviembre'
WHEN 12 THEN 'Diciembre' END
WHERE PERIODO = ${PERIODO}
AND CAST(FORMAT_DATE("%Y/%m/%d)",DATE(FECHA)) AS STRING) = CAST(FORMAT_DATE("%Y/%m/%d)", CURRENT_DATE("America/Bogota")) AS STRING);