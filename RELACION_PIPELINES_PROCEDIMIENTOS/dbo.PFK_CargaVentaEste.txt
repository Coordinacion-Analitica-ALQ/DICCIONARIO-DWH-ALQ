DECLARE PERIODOP INT64;
SET PERIODOP = CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);

/*DELETE COMERCIAL.FK_VENTASA
FROM COMERCIAL.FK_VENTASA AS V INNER JOIN MAESTRO.CLIENTES AS C
ON V.CODIGO_CLIENTE=C.CODIGO
WHERE V.PERIODO=PERIODOP AND C.CODI_EMPRESA IN ('GA','DN')
AND C.CODI_UNIDAD='RES' AND C.CODI_CANALSUPE='SM';*/

/*DELETE COMERCIAL.FK_VENTASA 
WHERE CODIGO_CLIENTE IN (SELECT CODIGO FROM MAESTRO.CLIENTES)
AND PERIODO = PERIODOP
AND (SELECT CODI_EMPRESA FROM MAESTRO.CLIENTES) IN ('GA', 'DN')
AND (SELECT CODI_UNIDAD FROM MAESTRO.CLIENTES) = 'RES'
AND (SELECT CODI_CANALSUPE FROM MAESTRO.CLIENTES) = 'SM';*/


DECLARE PERIODOP INT64;
SET PERIODOP = CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);

INSERT INTO COMERCIAL.FK_VENTASA (CODI_EMPRESA,
NUM_INTERNO,
CODI_ARTICULO,
UNIDAD_BRUTO,
LITRO_BRUTO,
VALOR_BRUTO,
FECHA_FACTURA,
CODI_CANALSUPE,
CODI_CANAL,
CODI_DISTRITO,
CODI_ZONA,
VALOR_NC,
UNID_NC,
LITRO_NC,
VALOR_DESC,
VALOR_DEVO,
UNID_NETO,
VALOR_NETO,
LITRO_NETO,
CODI_REGION,
CODI_CIUDAD,
NUME_PEDIDO,
CARTERA,
PERIODO,
CODI_BODEGA,
CODI_CAUSA,
IVA,
VALOR_UNITARIO,
TIPO_DOCU,
CODI_ARTEMP,
CODIGO_CLIENTE,
NUMERO_LEGAL,
ID_FECHA,
CODI_SUBCAUSA,
CODIGO_CAUSAL,
CODIGO_SUBCAUSAL,
CODI_CANALASOC,
CODI_CLIENTE,
CODI_RUTA,
CODI_VENDEDOR,
NOMBRE_VENDEDOR,
CODI_EQUIVALENCIA,
CODIGO_ARTICULO,
CODI_CLIENTE_H,
CODI_SECUENCIA,
INDICA_KIT,
TOT_ARTKIT,
DESC_POSV)

SELECT SUBSTRING(C.CODI_EMPRESA,1,2) AS CODI_EMPRESA, SUBSTRING(NUM_INTERNO,1,15) AS NUM_INTERNO, 
SUBSTRING(P.CODI_ARTICULO,1,10) AS CODI_ARTICULO, UNIDAD_BRUTO, LITRO_BRUTO, 
VALOR_BRUTO, FECHA_FACTURA, C.CODI_CANALSUPE, C.CODI_CANAL, C.CODI_DISTRITO,
C.CODI_ZONA, VALOR_NC, UNID_NC, LITRO_NC, VALOR_DESC, VALOR_DEVO, 
UNID_NETO, VALOR_NETO, LITRO_NETO, CODI_REGION, SUBSTRING(C.CODI_CIUDAD,1,6) AS CODI_CIUDAD, 
SUBSTRING(NUM_INTERNO,1,15) AS NUM_INTERNO,CARTERA, PERIODO, SUBSTRING(CODI_BODEGA,1,6) AS CODI_BODEGA, 
SUBSTRING(CODI_CAUSA,1,3) AS CODI_CAUSA,
IVA, VALOR_UNITARIO, SUBSTRING(TIPO_DOCU,1,2) AS TIPO_DOCU, CODI_ARTEMP, CODIGO_CLIENTE, 
SUBSTRING(NUMERO_LEGAL,1,20) AS NUMERO_LEGAL, ID_FECHA, SUBSTRING(CODI_SUBCAUSA,1,5) AS CODI_SUBCAUSA, CODIGO_CAUSAL,
CODIGO_SUBCAUSAL, C.CODI_CANALASOC,SUBSTRING( C.CODI_CLIENTE,1,8) AS CODI_CLIENTE, 
COALESCE(CODI_RUTA,'99'), COALESCE (C.CODIGO_VENDEDOR,'99'), 
NOMBRE_VENDEDOR,NULL AS CODI_EQUIVALENCIA, 0 AS CODIGO_ARTICULO, NULL AS CODI_CLIENTE_H, NULL AS CODI_SECUENCIA, CAST(INDICA_KIT AS STRING),TOT_ARTKIT,DESC_POSV
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL AS V INNER JOIN MAESTRO.CLIENTES AS C
ON V.CODIGO_CLIENTE =C.CODIGO INNER JOIN MAESTRO.JERARQUIA_PRODUCTO AS P
ON V.CODI_ARTEMP=P.CODIGO
WHERE C.CODI_UNIDAD='RES'
AND CODI_LINEA IN ('02','04','07','08','C4','D1' )
AND C.CODI_CANALSUPE='SM'
AND P.CODI_EMPRESA IN ('GA','DN')
AND PERIODO=PERIODOP