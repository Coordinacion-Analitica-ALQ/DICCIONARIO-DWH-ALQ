DECLARE periodop INT64 DEFAULT CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);
DECLARE dia INT64 DEFAULT EXTRACT(DAY FROM CURRENT_DATE("America/Bogota"));
DECLARE diashmes FLOAT64 DEFAULT (SELECT DIAS_HABILES FROM COMERCIAL.PERIODO_DIASH WHERE PERIODO=periodop LIMIT 1);
DECLARE dialineal NUMERIC DEFAULT (SELECT SUM(PESO_DIA) FROM MAESTRO.DIM_TIEMPOS WHERE PERIODO = periodop AND 
                FORMAT_DATE("%Y/%m/%d", DATE(FECHA)) <= FORMAT_DATE("%Y/%m/%d",CURRENT_DATE("America/Bogota")));



DELETE COMERCIAL.VENTA_INDICADORES_TOTALFK_DIA WHERE PERIODO=periodop;


INSERT INTO COMERCIAL.VENTA_INDICADORES_TOTALFK_DIA
SELECT V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA,ID_FECHA_REQ ID_FECHA,NUM_INTERNO ,TIPO_DOCU,CODI_ESTRUCTURA, 
SUM(LITRO_NETO) LITRO_NETO ,SUM(VALOR_NETO) VALOR_NETO,SUM(LITRO_NC) LITRO_NC,SUM(VALOR_NC) VALOR_NC ,
CODI_SUBCAUSA,SUM(VALOR_BRUTO)-SUM(VALOR_NC) AS VALOR_FACTURADO,V.CODIGO_SUBCAUSAL,V.CODIGO_CAUSAL,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(CAST(VALOR_NETO AS NUMERIC))/round(CAST(R.PESO_DIAHTRANS AS NUMERIC),2) )* CAST(diashmes AS NUMERIC) ELSE 0  END AS VALOR_PROYECCION, 
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(CAST(LITRO_NETO AS NUMERIC))/round(CAST(R.PESO_DIAHTRANS AS NUMERIC),2) )* CAST(diashmes AS NUMERIC) ELSE 0 END AS LITRO_PROYECCION,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN ((SUM(CAST(VALOR_BRUTO AS NUMERIC))+SUM(CAST(VALOR_NC AS NUMERIC)))/round(CAST(R.PESO_DIAHTRANS AS NUMERIC),2))* CAST(diashmes AS NUMERIC)  ELSE 0 END AS FACT_PROYECCION,
R.PESO_DIAHTRANS,diashmes,R.PESO_DIAHTRANS, --este dato se cambia por  @DIA_LINEAL sila proyeccion es lineal
sum(COALESCE( VALOR_BRUTO,0)) ,sum(COALESCE(VALOR_DESC,0)), sum(COALESCE(VALOR_DEVO,0)) , sum(COALESCE(DESC_POSV,0)) DESC_POSTV ,
sum(UNIDAD_BRUTO)  , sum(UNID_NC),sum(UNID_NETO)  , sum(CARTERA)
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL AS V INNER JOIN 
MAESTRO.JERARQUIA_PRODUCTO AS P ON V.CODI_ARTEMP=P.CODIGO
INNER JOIN MAESTRO.CLIENTES AS C ON  V.CODIGO_CLIENTE=C.CODIGO
INNER JOIN MAESTRO.TABLEAU_PesoDiaRegional AS R ON R.CODI_REGIONAL=C.CODI_UNIDAD  
WHERE C.CODI_EMPRESA IN ('GA')  AND P.CODI_LINEA IN  ( '02', '04', '07','08', 'D1',   'C4' ) --,'Z1' 
AND C.CODI_CANALSUPE NOT IN ('DO','FK','IC') AND (V.CODI_CLIENTE NOT IN ('DRP9991',  'DRP9992'))
AND R.PERIODO=V.PERIODO   AND ( V.PERIODO =periodop) 
AND FORMAT_DATE("%Y/%m/%d", DATE(V.FECHA_REQU_PED)) <= FORMAT_DATE("%Y/%m/%d", DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY))
AND P.CODI_ARTICULO <>'CARTGA'  AND V.INDICA_KIT <> 2 
GROUP BY V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA,ID_FECHA_REQ,NUM_INTERNO,TIPO_DOCU,CODI_ESTRUCTURA ,
CODI_SUBCAUSA, CODIGO_SUBCAUSAL,CODIGO_CAUSAL,R.PESO_DIAHTRANS;


INSERT INTO COMERCIAL.VENTA_INDICADORES_TOTALFK_DIA
SELECT V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA,ID_FECHA_REQ ID_FECHA,NUM_INTERNO ,TIPO_DOCU,CODI_ESTRUCTURA, 
SUM(LITRO_NETO) LITRO_NETO ,SUM(VALOR_NETO) VALOR_NETO,SUM(LITRO_NC) LITRO_NC,SUM(VALOR_NC) VALOR_NC ,
CODI_SUBCAUSA,SUM(VALOR_BRUTO)-SUM(VALOR_NC) AS VALOR_FACTURADO,V.CODIGO_SUBCAUSAL,V.CODIGO_CAUSAL,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(CAST(VALOR_NETO AS NUMERIC))/round(CAST(R.PESO_DIAHTRANS AS NUMERIC),2) )* CAST(diashmes AS NUMERIC) ELSE 0  END AS VALOR_PROYECCION, 
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(CAST(LITRO_NETO AS NUMERIC))/round(CAST(R.PESO_DIAHTRANS AS NUMERIC),2) )* CAST(diashmes AS NUMERIC) ELSE 0 END AS LITRO_PROYECCION,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN ((SUM(CAST(VALOR_BRUTO AS NUMERIC))+SUM(CAST(VALOR_NC AS NUMERIC)))/round(CAST(R.PESO_DIAHTRANS AS NUMERIC),2))* CAST(diashmes AS NUMERIC)  ELSE 0 END AS FACT_PROYECCION,
R.PESO_DIAHTRANS,diashmes,R.PESO_DIAHTRANS, --este dato se cambia por  @DIA_LINEAL sila proyeccion es lineal 
sum( VALOR_BRUTO) ,sum(VALOR_DESC), sum(VALOR_DEVO) ,sum(DESC_POSV) ,
sum(UNIDAD_BRUTO)  , sum(UNID_NC),sum(UNID_NETO)  , sum(CARTERA)
FROM COMERCIAL.VENTAS_REPORTE_MENSUAL AS V    INNER JOIN 
MAESTRO.JERARQUIA_PRODUCTO AS P ON V.CODI_ARTEMP=P.CODIGO
INNER JOIN MAESTRO.CLIENTES AS C ON  V.CODIGO_CLIENTE=C.CODIGO
INNER JOIN MAESTRO.TABLEAU_PesoDiaRegional AS R ON R.CODI_REGIONAL=C.CODI_UNIDAD  
WHERE C.CODI_EMPRESA IN ('DN')  AND P.CODI_LINEA IN ('D1', 'C4','02' )  
AND C.CODI_CANALSUPE NOT IN ('DO','FK','IC')   AND (V.CODI_CLIENTE NOT IN ('DRP9991',  'DRP9992'))  
AND R.PERIODO=V.PERIODO  AND ( V.PERIODO=periodop)  
AND FORMAT_DATE("%Y/%m/%d", DATE(V.FECHA_REQU_PED)) <= FORMAT_DATE("%Y/%m/%d", DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY))
AND P.CODI_ARTICULO <>'CARTGA'   AND V.INDICA_KIT <>2
GROUP BY V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA,ID_FECHA_REQ ,NUM_INTERNO,TIPO_DOCU,CODI_ESTRUCTURA ,
CODI_SUBCAUSA,CODIGO_SUBCAUSAL,CODIGO_CAUSAL,R.PESO_DIAHTRANS;


INSERT INTO COMERCIAL.VENTA_INDICADORES_TOTALFK_DIA
SELECT V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA, ID_FECHA,NUM_INTERNO ,TIPO_DOCU,7 CODI_ESTRUCTURA, 
SUM(LITRO_NETO) LITRO_NETO ,SUM(VALOR_NETO) VALOR_NETO,SUM(LITRO_NC) LITRO_NC,SUM(VALOR_NC) VALOR_NC ,
CODI_SUBCAUSA,SUM(VALOR_BRUTO)-SUM(VALOR_NC) AS VALOR_FACTURADO,V.CODIGO_SUBCAUSA,V.CODIGO_CAUSAL,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(CAST(VALOR_NETO AS NUMERIC))/round(CAST(R.PESO_DIAHTRANS AS NUMERIC),2) )* CAST(diashmes AS NUMERIC) ELSE 0  END AS VALOR_PROYECCION, 
CASE WHEN R.PESO_DIAHTRANS<>0 THEN  (SUM(CAST(LITRO_NETO AS NUMERIC))/round(CAST(R.PESO_DIAHTRANS AS NUMERIC),2) )* CAST(diashmes AS NUMERIC) ELSE 0 END AS LITRO_PROYECCION,
CASE WHEN R.PESO_DIAHTRANS<>0 THEN ((SUM(CAST(VALOR_BRUTO AS NUMERIC))+SUM(CAST(VALOR_NC AS NUMERIC)))/round(CAST(R.PESO_DIAHTRANS AS NUMERIC),2))* CAST(diashmes AS NUMERIC)  ELSE 0 END AS FACT_PROYECCION,
R.PESO_DIAHTRANS,diashmes,R.PESO_DIAHTRANS, --este dato se cambia por  @DIA_LINEAL sila proyeccion es lineal
sum( VALOR_BRUTO) ,sum(VALOR_DESC), sum(VALOR_DEVO) ,sum(DESC_POSV) ,
sum(UNIDAD_BRUTO)  , sum(UNID_NC),sum(UNID_NETO)  , sum(CARTERA)
FROM  COMERCIAL.VENTAS_REPORTE_MENSUAL_FK AS V    INNER JOIN 
MAESTRO.JERARQUIA_PRODUCTO AS P    ON V.CODI_ARTEMP=P.CODIGO
INNER JOIN MAESTRO.CLIENTES AS C  ON  V.CODIGO_CLIENTE=C.CODIGO
INNER JOIN MAESTRO.TABLEAU_PesoDiaRegional AS R ON R.CODI_REGIONAL=C.CODI_UNIDAD  
WHERE P.CODI_LINEA IN (  '02','04', '07', '08', 'D1', 'C4' ) --,'Z1' 
AND  CODI_CAUSA NOT IN ('F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'F13', 'F14', 'F15', 'F16', 'F17', 'F18', 'F19', 'F20')
AND C.CODI_CANALSUPE NOT IN ('DO','FK','IC')  AND (V.CODI_CLIENTE NOT IN ('DRP9991',  'DRP9992'))
AND R.PERIODO=V.PERIODO  AND ( V.PERIODO =periodop)  
AND FORMAT_DATE("%Y/%m/%d", DATE(FECHA_FACTURA)) <= FORMAT_DATE("%Y/%m/%d", DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY))
AND P.CODI_ARTICULO <>'CARTGA'  AND C.CODI_EMPRESA='FK'
GROUP BY  V.PERIODO,CODIGO_CLIENTE,CODI_ARTEMP,CODI_CAUSA,ID_FECHA ,NUM_INTERNO,TIPO_DOCU ,
CODI_SUBCAUSA,CODIGO_SUBCAUSA,CODIGO_CAUSAL,R.PESO_DIAHTRANS;



UPDATE COMERCIAL.VENTA_INDICADORES_TOTALFK_DIA
SET DIAS_TOT_MES=25.8
FROM COMERCIAL.VENTA_INDICADORES_TOTALFK_DIA AS V INNER JOIN MAESTRO.CLIENTES AS C
ON V.CODIGO_CLIENTE=C.CODIGO
WHERE V.PERIODO=11912  and C.CODI_UNIDAD='RES';
