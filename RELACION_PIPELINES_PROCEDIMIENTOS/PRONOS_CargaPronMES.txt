DECLARE mes INT64 DEFAULT EXTRACT(MONTH FROM CURRENT_DATE("America/Bogota"));
DECLARE periodop INT64 DEFAULT CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);

DELETE COMERCIAL.PRONOSTICO_COMERCIAL WHERE PERIODO= periodop; 


INSERT INTO COMERCIAL.PRONOSTICO_COMERCIAL 
( PERIODO, CODI_EMPRESA, CODI_UNIDAD, CODI_REGIONAL, CODI_CANALAGRUP, CODI_CANALSUPE, CODI_CANAL, 
CODI_TIPOLOGIA, CODI_LINEA, CODI_GRUPO, CODI_SUBGRUPO, CODI_PRESENTACION, CODI_TAMANO, CODI_ARTICULO, 
VALOR, LITROS,   CODI_MARCA, NOMBRE_UNIDAD, NOMBRE_REGION, NOMBRE_CANALASOC, NOMBRE_CANALSUPE, 
NOMBRE_CANAL, NOMBRE_TIPOLOGIA, DESC_LINEA, DESC_GRUPO, DESC_SUBGRUPO, DESC_PRESENTACION, DESC_TAMANO, 
NOMBRE_MARCA, DESCRIPCION, EMPRESA_PRODUCTORA, CODI_ESTRUCTURA,CATEGORIA_COMERCIAL,CATEGORIA_COMERCIAL_MODERNO,
CODIGO_REGIONSUPE,REGIONAL_SUPERIOR,CODIGO_SECTOR,SECTOR)

SELECT  CAST(PERIODO AS INT64) , SUBSTRING(P.CODIGO_EMPRESA,1,2) CODI_EMPRESA,SUBSTRING(P.CODIGO_REGIONAL,1,3),
SUBSTRING(P.CODIGO_REGION,1,3),
SUBSTRING(CODIGO_CANAL_AGRUP ,1,2) CODI_CANALAGRU, SUBSTRING(P.CODIGO_CANALSUPE,1,2), 
SUBSTRING(P.CODIGO_CANAL_INF,1,2), 
SUBSTRING(TIPOLOGIA,1,2) TIPOLOGIA, 
SUBSTRING(CODIGO_CATEGORIA,1,2) ,SUBSTRING(P.CODIGO_GRUPO,1,2) ,SUBSTRING(P.CODIGO_SUBGRUPO,1,2),
SUBSTRING(P.CODI_PRESENTACION,1,2),SUBSTRING(P.CODI_TAMANO,1,10),
SUBSTRING(P.CODIGO_ARTICULO,1,15),CAST(SUM(VALOR_NETO ) AS NUMERIC), CAST(SUM(LITRO_NETO ) AS NUMERIC), SUBSTRING(P.CODIGO_MARCA,1,2) ,
SUBSTRING(NOMBRE_REGIONAL,1,50),SUBSTRING(NOMBRE_REGION,1,50),SUBSTRING(NOMBRE_CANAL_AGRUPA,1,50),
SUBSTRING(NOMBRE_CANALSUPE,1,50), SUBSTRING(NOMBRE_CANAL,1,50) ,SUBSTRING(NOMBRE_TIPOLOGIA,1,50),
SUBSTRING(NOMBRE_CATEGORIA,1,50),SUBSTRING(NOMBRE_GRUPO,1,50) ,SUBSTRING(NOMBRE_SUBGRUPO,1,50),
SUBSTRING(P.DESC_PRESENTACION,1,50),SUBSTRING(P.DESC_TAMANO,1,50),SUBSTRING(NOMBRE_EMP_FISCAL,1,50),
DESCRIPCION,SUBSTRING(P.NOMBRE_MARCA,1,50) ,0 ,SUBSTRING(CATEGORIA_COMERCIAL,1,50) 
,SUBSTRING(categoria_comercial_moderno,1,50) ,
substring(CODIGO_REGIONSUPE,1,3),substring(REGIONAL_SUPERIOR,1,50),substring(CODIGO_SECTOR,1,3),
substring(SECTOR,1,50)
from   MAESTRO.PLANTILLA_MES AS P where P.CODIGO_EMPRESA IN ('GA','DN','FK')
GROUP BY P.PERIODO, P.CODIGO_EMPRESA,P.CODIGO_REGIONAL,CODIGO_REGION,CODIGO_CANAL_AGRUP,
CODIGO_CANALSUPE,CODIGO_CANAL_INF,P.CODIGO_MARCA, CODIGO_GRUPO, CODIGO_SUBGRUPO,
P.CODI_PRESENTACION,P.CODIGO_ARTICULO, P.CODI_TAMANO,  P.CODIGO_MARCA
,SUBSTRING(TIPOLOGIA,1,2),DESCRIPCION, NOMBRE_EMP_FISCAL,CODIGO_CATEGORIA,
CODIGO_REGIONAL,CODIGO_REGION,NOMBRE_CANAL_AGRUPA,NOMBRE_CANALSUPE,
NOMBRE_CANAL,NOMBRE_TIPOLOGIA,NOMBRE_CATEGORIA,NOMBRE_GRUPO,NOMBRE_SUBGRUPO,
P.DESC_PRESENTACION,P.DESC_TAMANO,NOMBRE_EMP_FISCAL ,P.DESCRIPCION,P.NOMBRE_MARCA,
NOMBRE_REGIONAL,NOMBRE_REGION,SUBSTRING( CATEGORIA_COMERCIAL,1,50) ,SUBSTRING( categoria_comercial_moderno,1,50) 
,CODIGO_REGIONSUPE,REGIONAL_SUPERIOR,CODIGO_SECTOR,SECTOR;

UPDATE COMERCIAL.PRONOSTICO_COMERCIAL
SET CODI_TIPOLOGIA=''
WHERE CODI_TIPOLOGIA='(e' 
AND  PERIODO= periodop;

update COMERCIAL.PRONOSTICO_COMERCIAL
SET CODI_ARTEMP=P.CODIGO
FROM COMERCIAL.PRONOSTICO_COMERCIAL D INNER JOIN MAESTRO.JERARQUIA_PRODUCTO P
ON D.CODI_EMPRESA=P.CODI_EMPRESA AND D.CODI_ARTICULO=P.CODI_ARTICULO
WHERE D.PERIODO=periodop;


UPDATE COMERCIAL.PRONOSTICO_COMERCIAL
SET CODI_ESTRUCTURA=1
WHERE DESCRIPCION='VENTAS' AND  PERIODO= periodop;


UPDATE COMERCIAL.PRONOSTICO_COMERCIAL
SET CODI_ESTRUCTURA=2
WHERE DESCRIPCION='VENTAS DASA'  AND  PERIODO= periodop;


