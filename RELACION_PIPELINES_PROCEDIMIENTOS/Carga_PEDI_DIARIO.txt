DECLARE periodop INT64 DEFAULT CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);
DECLARE periodoa INT64 DEFAULT CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 2 DAY)) AS INT64);
DECLARE dia1 INT64 DEFAULT EXTRACT( DAY FROM DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 2 DAY));
DECLARE dia3 INT64 DEFAULT EXTRACT( DAY FROM DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY));
DECLARE dia2 STRING DEFAULT CASE WHEN LENGTH(CAST(dia1 AS STRING)) = 1 THEN CONCAT(CAST(periodoa AS STRING), '0', CAST(dia1 AS STRING)) ELSE CONCAT(CAST(periodoa as STRING), CAST(dia1 AS STRING)) END;
DECLARE diafin STRING DEFAULT CASE WHEN LENGTH(CAST(dia3 AS STRING)) = 1 THEN CONCAT(CAST(periodop AS STRING), '0', CAST(dia3 AS STRING)) ELSE CONCAT(CAST(periodop AS STRING), CAST(dia3 AS STRING)) END;

TRUNCATE TABLE LOGISTICA.PEDIDOS_vs_DESPACHOS_MES;

INSERT INTO LOGISTICA.PEDIDOS_vs_DESPACHOS_MES
( PERIODO, CODI_EMPRESA, FECHA_REQUERIDA, CODI_CLIENTE, SECUENCIA, CODI_ARTICULO, 
NOVEDAD, CODIGO_NOVEDAD, ESTADO_PEDIDO, MODIFICADO, NUMERO_PEDIDO, LINEA_PEDIDO, FACTOR, CANTIDAD_PEDIDO, 
CANTIDAD_DESPACHO, CANTIDAD_NUEVA, LITRO_PEDIDO, LITRO_DESPACHADO, DIFERENCIA, LITRO_PEDINUEV, 
ESTADO_PEDIDO_TOTAL,CTROTRANSP_UNIFICADO,FECHA_PEDIDO ,ORIGEN_PEDIDO,CODIGO_CANCELAPEDIDO ,VALOR_TOTAL,PRECIO_UNITARIO )

SELECT DISTINCT periodop AS  PERIODO, A.CONO55 CODI_EMPRESA, A.DTDR55   FECH_REQUE, 
RTRIM(LTRIM(A.CUSN55)) CODI_CLIENTE, RTRIM(LTRIM(A.DSEQ55)) AS SECUENCIA_CLIENTE, 
A.CATN55 CODI_ARTICULO, '' NOVEDAD, 1 CODI_NOVEDAD, A.STAT55 AS ESTADO_PEDIDO,
CASE WHEN SUM((A.QTOR55)) <> SUM((B.QTON55))  THEN 'M'  ELSE 'N' end   as PEDI_MODIFICA,
A.ORDN55 NUME_PEDIDO,  A.ORDL55 ORDEN_PEDIDO, WTSU35  FACTOR,  SUM(A.QTOR55)  CANT_PEDIDA, 
SUM(A.QTDS55)  CANT_DESP,    SUM(B.QTON55)   CANT_NUEVA, 
SUM((A.QTOR55 * WTSU35)) AS LITRO_PEDIDO, 
SUM(( A.QTDS55 *  WTSU35 )) AS LITRO_DESPA,
SUM(( A.QTOR55  -  A.QTDS55)) * WTSU35  AS DIFERENCIA,
CASE WHEN  SUM((B.QTON55))  < 100000 THEN  SUM((B.QTON55  * WTSU35)) ELSE 0 END AS LITRO_PEDINUEV   ,
C.STAT40  ESTADOTOT  ,RTRIM(LTRIM(A.CONO55+A.LOCD55)) AS CTROTRANSP_UNIFICADO, 
DTCO40 FECHA_PEDIDO,   OSRC40  AS origen ,A.RSNC55 Causacancela,SUM(A.ORLV55) VLR_TOTAL,SUM(A.UPRC55) PRECIO_UNITARIO
FROM    PRUBSYSTEM.S10EB95C.AULT2F3ALQ.OEP55 A   
INNER JOIN   PRUBSYSTEM.S10EB95C.AULT2F3ALQ.INP35
ON A.CONO55=CONO35 AND A.CATN55 =PNUM35
INNER JOIN       PRUBSYSTEM.S10EB95C.AULT2F3ALQ.OEP40 C ON 
A.CONO55 = C.CONO40 AND A.ORDN55 = C.ORDN40  AND A.CUSN55=C.CUSN40
AND  A.DSEQ55=C.DSEQ40
INNER JOIN  PRUBSYSTEM.S10EB95C.ALQMODF3AL.OEALP055 B ON
A.CONO55=B.CONO55 AND A.ORDN55=B.ORDN55  AND A.CUSN55=B.CUSN55 AND A.DSEQ55=B.DSEQ55
AND  A.CATN55=B.CATN55  AND A.ORDL55=B.ORDL55
WHERE ( A.DTDR55= diafin ) 
AND A.OSRC55 <> 'M' AND A.PTYP55 <> 'K' 
AND A.CONO55 IN (  'GA','DN' ) AND PCLS35  IN ( '02','04','07','08', 'C4' ,'D1' )
GROUP BY A.CONO55  , A.DTDR55 ,A.CUSN55,A.DSEQ55,A.CATN55,A.STAT55,A.ORDN55  ,  A.ORDL55  , WTSU35 ,C.STAT40,A.LOCD55,
DTCO40, OSRC40   ,A.RSNC55;

UPDATE LOGISTICA.PEDIDOS_vs_DESPACHOS_MES
SET CTROTRANSP_UNIFICADO=CONCAT(CODI_EMPRESA, '99')
WHERE (CTROTRANSP_UNIFICADO IS NULL OR CTROTRANSP_UNIFICADO='' OR CTROTRANSP_UNIFICADO=' ');

UPDATE LOGISTICA.PEDIDOS_vs_DESPACHOS_MES AS P
SET CODIGO_CTROTUNIFICADO=CAST(B.DESC_BODEGA AS INT64)
FROM MAESTRO.DIM_BODEGA AS B 
WHERE CONCAT(LTRIM(RTRIM(B.CODI_EMPRESA)), LTRIM(RTRIM(B.CODI_BODEGA)))=LTRIM(RTRIM(P.CTROTRANSP_UNIFICADO));

UPDATE LOGISTICA.PEDIDOS_vs_DESPACHOS_MES
SET CODIGO_CANCELAPEDIDO='98'
WHERE ESTADO_PEDIDO<>'X';

UPDATE LOGISTICA.PEDIDOS_vs_DESPACHOS_MES
SET CODIGO_CANCELAPEDIDO='96'
WHERE ( CODIGO_CANCELAPEDIDO IS NULL OR CODIGO_CANCELAPEDIDO='' OR CODIGO_CANCELAPEDIDO=' ')
AND ESTADO_PEDIDO='X';

UPDATE LOGISTICA.PEDIDOS_vs_DESPACHOS_MES AS P
SET PK_CAUSA=B.PK_CODIGO
FROM LOGISTICA.CAUSAL_PEDIDO AS B
WHERE P.CODI_EMPRESA= B.CODI_EMPRESA  AND P.CODIGO_CANCELAPEDIDO =B.CODIGO_CUASAL_PEDIDO;

DECLARE conteo NUMERIC;
DECLARE periodop INT64 DEFAULT CAST(FORMAT_DATE("1%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY)) AS INT64);
SET conteo =  CAST( (SELECT COUNT(*) FROM LOGISTICA.PEDIDOS_vs_DESPACHOS_MES) AS INT64);

INSERT INTO MAESTRO.DIANA_AUDITORIA
(NOMBRE_TABLA, FECHA, PERIODO, NUMERO_REGISTROS, DIFERENCIA)
VALUES (' PEDIDOS_vs_DESPACHOS_MES',  CURRENT_TIMESTAMP() , periodop, conteo, 0);


