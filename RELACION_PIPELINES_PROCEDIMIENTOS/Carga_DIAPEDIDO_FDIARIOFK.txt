SELECT FN.PERIODO() AS PERIODO;

DELETE MAESTRO.FK_PEDIDO_DIA 
WHERE PERIODO = CAST(${PERIODO} AS STRING)
AND CODIGO_CLIENTE IS NULL OR CODIGO_CLIENTE = 0;

DELETE MAESTRO.FK_PEDIDO_DIA 
WHERE PERIODO = CAST(${PERIODO} AS STRING)
AND CODI_ARTEMP IS NULL OR CODI_ARTEMP = 0;


DELETE LOGISTICA.PEDIDOS_vs_DESPACHOS_DIA
WHERE PERIODO=${PERIODO}  AND CODI_EMPRESA='FK';

INSERT INTO LOGISTICA.PEDIDOS_vs_DESPACHOS_DIA
( PERIODO, CODI_EMPRESA, FECHA_REQUERIDA, CODI_CLIENTE, SECUENCIA, CODI_ARTICULO, CODIGO_CLIENTE, 
CODI_ARTEMP, ID_FECHA_REQUERIDA, CODI_ESTRUCTURA, NOVEDAD, CODIGO_NOVEDAD, ESTADO_PEDIDO, 
ID_MODIFICADO, NUMERO_PEDIDO, LINEA_PEDIDO, FACTOR, CANTIDAD_PEDIDO, CANTIDAD_DESPACHO, CANTIDAD_NUEVA, LITRO_PEDIDO, LITRO_DESPACHADO, 
DIFERENCIA, LITRO_PEDINUEV, ESTADO_PEDIDO_FIN,CODIGO_CTROTUNIF,FECHA_PEDIDO,ORIGEN_PEDIDO,
CODI_ESTADO_LINEA,CODI_ESTADO_PEDIDO,CODI_EQUIVALENCIA,PK_CANCELA )
SELECT    CAST(P.PERIODO AS INT64) PERIODO,  CODI_EMPRESA,  
TIMESTAMP(PARSE_DATE("%Y%m%d", FECHA_REQUERIDA)) AS FECHA_REQUERIDA,
P.CODI_CLIENTE, P.SECUENCIA, 
P.CODI_EQUIVALENCIA, P.CODIGO_CLIENTE,  P.CODI_ARTEMP,0 ID_FECHA_REQ,
CAST('1' AS INT64) CODI_ESTRUCTURA, CASE WHEN P.ESTADO_PEDIDO='C' THEN 'Completo' else 'Incompleto' end NOVEDAD, 
case WHEN P.ESTADO_PEDIDO='C' THEN 1 else 2 end CODIGO_NOVEDAD,
P.ESTADO_PEDIDO , 
CASE WHEN P.MODIFICADO='N'   THEN 1 ELSE 2 END  ID_MODIFICADO ,   
NUMERO_PEDIDO, CAST(LINEA_PEDIDO AS INT64) LINEA_PEDIDO,   0 FACT_CONVER, 
SUM(CAST(P.CANTIDAD_PEDIDO AS NUMERIC)) CANTIDAD_PEDIDO,   
SUM(CAST(CANTIDAD_DESPACHO AS NUMERIC))  CANTIDAD_DESPACHO,
SUM(CAST(CANTIDAD_NUEVA AS NUMERIC)) CANTIDAD_NUEVA,   
SUM(CAST(LITRO_PEDIDO AS NUMERIC)) LITRO_PEDIDO, 
SUM(CAST(LITRO_DESPACHADO AS NUMERIC)) LITRO_DESPACHADO ,    
(SUM(CAST(LITRO_PEDIDO AS NUMERIC)) - SUM(CAST(LITRO_DESPACHADO AS NUMERIC)) ) DIFERENCIA, 
SUM(CAST(LITRO_PEDINUEV AS NUMERIC)) LITRO_PEDINUEV,   
P.ESTADO_PEDIDO_TOTAL, CODIGO_CTROTUNIF,   
TIMESTAMP(PARSE_DATE("%Y%m%d", P.FECHA_PEDIDO)) AS FECHA_PEDIDO, ORIGEN_PEDIDO,
CASE WHEN P.ESTADO_PEDIDO='C' THEN 3 ELSE 2 END CODI_ESTADO_LINEA,
CASE WHEN P.ESTADO_PEDIDO_TOTAL='C' THEN 3 ELSE 2 END  CODI_ESTADO_PEDIDO ,CODI_EQUIVALENCIA,   PK_CAUSAL
FROM  MAESTRO.FK_PEDIDO_DIA    P 	 
WHERE  P.PERIODO =CAST(${PERIODO} AS STRING) AND LENGTH(CODI_ARTICULO)>0
GROUP BY P.PERIODO,  CODI_EMPRESA, P.FECHA_REQUERIDA,P.ESTADO_PEDIDO,NUMERO_PEDIDO,LINEA_PEDIDO,P.ESTADO_PEDIDO_TOTAL
,P.FECHA_PEDIDO, P.CODI_CLIENTE, P.SECUENCIA,    P.MODIFICADO, ORIGEN_PEDIDO,P.CODIGO_CLIENTE,  P.CODI_ARTEMP,P.CODI_EQUIVALENCIA,PK_CAUSAL,CODIGO_CTROTUNIF 
ORDER BY PERIODO, CODI_EMPRESA,NUMERO_PEDIDO,LINEA_PEDIDO,P.CODIGO_CLIENTE,  P.CODI_ARTEMP


