SELECT IF(EXTRACT(DAY FROM CURRENT_DATE("America/Bogota")) = 1,CONCAT("1",FORMAT_DATE("%y%m",DATE_SUB(CURRENT_DATE("America/Bogota"), INTERVAL 1 DAY))),CONCAT("1",FORMAT_DATE("%y%m",CURRENT_DATE("America/Bogota")))) AS PERIODO;

delete from COMERCIAL.VENTAS_REPORTE_MENSUAL
WHERE PERIODO=${PERIODO};

UPDATE COMERCIAL.VIVENTAS_1 V
   SET CODI_CANALSUPE=C.CODI_CANALSUPE,
   CODI_CANAL=C.CODI_CANAL,
   CODI_DISTRITO=C.CODI_DISTRITO,
   CODI_ZONA=C.CODI_ZONA,
   CODI_REGIONAL=C.CODI_REGION,
    CODI_CIUDAD=C.CODI_CIUDAD 
 FROM  MAESTRO.CLIENTES  C
 WHERE   V.CODI_EMPRESA=C.CODI_EMPRESA
 AND V.COD_CLIE=C.CODI_CLIENTE
 AND V.CLIE_DIRE=C.DIRE_ENTREGA;

 
  updaTE  COMERCIAL.VIVENTAS_1 V
    set     LITRO_NETO= CAST(CAST(V.CANTIDAD AS NUMERIC) * J.FACT_CONVER  AS INT64) 
    from    MAESTRO.JERARQUIA_PRODUCTO J
 WHERE   V.CODI_EMPRESA=J.CODI_EMPRESA
 AND V.CODI_ARTICULO=J.CODI_ARTICULO
 AND V.CODI_CAUSA <> 'V';
 
 UPDATE COMERCIAL.VIVENTAS_1 V
   SET 	INDICA_KIT=  '2' 
    from  MAESTRO.JERARQUIA_PRODUCTO J
 WHERE   V.CODI_EMPRESA=J.CODI_EMPRESA
 AND V.CODI_ARTICULO=J.CODI_ARTICULO
AND   J.TIPO_ARTICULO='Z';

INSERT   INTO  COMERCIAL.VENTAS_REPORTE_MENSUAL (CODI_EMPRESA, NUM_INTERNO, 
		CODI_ARTICULO, UNIDAD_BRUTO, LITRO_BRUTO, VALOR_BRUTO,  
		CODI_CLIENTE, FECHA_FACTURA, CODI_CANALSUPE, CODI_CANAL, CODI_DISTRITO, 
		CODI_ZONA, CLIE_DIRE, VALOR_NC, UNID_NC, LITRO_NC, VALOR_DESC, 
		VALOR_DEVO, UNID_NETO, VALOR_NETO, LITRO_NETO, 
		CODI_REGIONAL, CODI_CIUDAD, NUME_INTERNO, CARTERA, PERIODO,
        CODI_BODEGA, VALOR_OTRAMONE,IVA_OTRAMONE,
		CODI_CAUSA,IVA,VALOR_UNITARIO,TIPO_ARTFISCAL,TIPO_DOCU,
		CODI_ESTRUCTURA,NUMERO_LEGAL,ID_FECHA,NUMERO_PEDIDO,
		CODI_SUBCAUSA,CODIGO_CAUSAL,LINEA_NUMERO,FECHA_REQU_PED,ID_FECHA_REQ,
		 INDICA_KIT,TOT_ARTKIT,PADRE_KIT ,DESCU_ARTICULO,DESC_POSV)
		
		
		SELECT   CODI_EMPRESA, TRIM(NUM_INTERNO) NUM_INTERNO, 
		TRIM(V.CODI_ARTICULO) CODI_ARTICULO, CAST(CAST(CANTIDAD AS FLOAT64 ) AS NUMERIC) AS UNIDAD_BRUTO, 
		COALESCE (LITRO_NETO,0) LITRO_BRUTO, 
		CAST(CAST(COALESCE (PRECIO_PESOS,0) AS FLOAT64) AS NUMERIC)  VALOR_BRUTO, 
		TRIM(COD_CLIE) CODI_CLIENTE,   
		CAST(PARSE_DATE("%Y%m%d", CAST(FECHA_FACTURA + 19000000 AS STRING)) AS TIMESTAMP) as FECHA_FACTURA,
		 CODI_CANALSUPE, 
		 CODI_CANAL, CODI_DISTRITO,CODI_ZONA,
		TRIM(CLIE_DIRE) CLIE_DIRE, 0 AS  VALOR_NC,0 AS UNID_NC, 0  AS LITRO_NC, 
		0 VALOR_DESC, 0 VALOR_DEVO,CAST(CAST(CANTIDAD AS FLOAT64 ) AS NUMERIC)  UNID_NETO, 	
		CAST(CAST(COALESCE (PRECIO_PESOS,0) AS FLOAT64) AS NUMERIC) VALOR_NETO, 
		COALESCE (LITRO_NETO,0) LITRO_NETO,
		COALESCE (CODI_REGIONAL,'99')  CODI_REGIONAL, COALESCE(CODI_CIUDAD,'99') CODI_CIUDAD, 
		 TRIM(NUM_PEDIDO) AS  NUME_INTERNO,0 CARTERA, PERIODO,	
	    TRIM(CODI_BODEGA) CODI_BODEGA    ,0 VALOR_OTRAMONE,0  IVA_OTRAMONE,
		case  when CODI_CAUSA='' THEN '99' ELSE TRIM(CODI_CAUSA) END  CODI_CAUSA, 
		CAST(CAST(COALESCE (IVA_PESOS,0) AS FLOAT64) AS NUMERIC)  IVA,
		CAST(CAST(COALESCE (PRECIO_UNITARIO,0) AS FLOAT64) AS NUMERIC)   VALOR_UNITARIO ,'' TIPO_ARTFISCAL, TRIM(COD_TIPODOCU) TIPO_DOCU,
		CASE  CODI_EMPRESA  
				WHEN 'GA' THEN 1  
				WHEN 'DN' THEN 2   ELSE 3  END CODI_ESTRUCTURA, '' NUMERO_LEGAL,0 ID_FECHA,
				TRIM(NUM_PEDIDO) NUMERO_PEDIDO,
		case  when CODI_SUBCAUSA='' THEN '99' ELSE TRIM(CODI_SUBCAUSA) END CODI_SUBCAUSA, 
		0 CODIGO_CAUSAL,LINEA AS LINEA_NUMERO,
		 CAST(PARSE_DATE("%Y%m%d", CAST(FECHA_FACTURA + 19000000 AS STRING)) AS TIMESTAMP) FECHA_REQU_PED,
		0 ID_FECHA_REQ,	cast(cast( INDICA_KIT as string) as INT64) INDICA_KIT ,
		CAST(CAST(TOT_ARTKIT AS FLOAT64 ) AS INT64) TOT_ARTKIT  ,1  PADRE_KIT  ,  
		CAST(CAST(DESC_ARTICULO	AS FLOAT64)  AS NUMERIC) DESCU_ARTICULO , 0  DESC_POSV
		FROM         COMERCIAL.VIVENTAS_1   V   
	    WHERE     (V.COD_TIPODOCU = 'IN')   
		AND V.PERIODO =${PERIODO}
		AND FECHA_FACTURA <>0
		and CODI_CAUSA <>'V'
		AND (PRECIO_PESOS <>0  );

INSERT   INTO  COMERCIAL.VENTAS_REPORTE_MENSUAL (CODI_EMPRESA, NUM_INTERNO, 
		CODI_ARTICULO, UNIDAD_BRUTO, LITRO_BRUTO, VALOR_BRUTO,  
		CODI_CLIENTE, FECHA_FACTURA, CODI_CANALSUPE, CODI_CANAL, CODI_DISTRITO, 
		CODI_ZONA, CLIE_DIRE, VALOR_NC, UNID_NC, LITRO_NC, VALOR_DESC, 
		VALOR_DEVO, UNID_NETO, VALOR_NETO, LITRO_NETO, 
		CODI_REGIONAL, CODI_CIUDAD, NUME_INTERNO, CARTERA, PERIODO,
        CODI_BODEGA, VALOR_OTRAMONE,IVA_OTRAMONE,
		CODI_CAUSA,IVA,VALOR_UNITARIO,TIPO_ARTFISCAL,TIPO_DOCU,
		CODI_ESTRUCTURA,NUMERO_LEGAL,ID_FECHA,NUMERO_PEDIDO,
		CODI_SUBCAUSA,CODIGO_CAUSAL,LINEA_NUMERO,FECHA_REQU_PED,ID_FECHA_REQ,
		 INDICA_KIT,TOT_ARTKIT,PADRE_KIT ,DESCU_ARTICULO,DESC_POSV)
		
		
		SELECT   CODI_EMPRESA, TRIM(NUM_INTERNO) NUM_INTERNO, 
		TRIM(V.CODI_ARTICULO) CODI_ARTICULO, 0 AS UNIDAD_BRUTO, 
		0  LITRO_BRUTO, 
		0  VALOR_BRUTO, 
		TRIM(COD_CLIE) CODI_CLIENTE,   
		CAST(PARSE_DATE("%Y%m%d", CAST(FECHA_FACTURA + 19000000 AS STRING)) AS TIMESTAMP) as FECHA_FACTURA,
		 CODI_CANALSUPE, 
		 CODI_CANAL, CODI_DISTRITO,CODI_ZONA,
		TRIM(CLIE_DIRE) CLIE_DIRE, CAST(CAST(COALESCE (PRECIO_PESOS,0) AS FLOAT64) AS NUMERIC) AS  VALOR_NC,
        CAST(CAST(CANTIDAD AS FLOAT64 ) AS NUMERIC) AS UNID_NC,
         COALESCE (LITRO_NETO,0)  AS LITRO_NC, 
		0 VALOR_DESC, 0 VALOR_DEVO,CAST(CAST(CANTIDAD AS FLOAT64 ) AS NUMERIC)  UNID_NETO, 	
		CAST(CAST(COALESCE (PRECIO_PESOS,0) AS FLOAT64) AS NUMERIC) VALOR_NETO, 
		COALESCE (LITRO_NETO,0) LITRO_NETO,
		COALESCE (CODI_REGIONAL,'99')  CODI_REGIONAL, COALESCE(CODI_CIUDAD,'99') CODI_CIUDAD, 
		 TRIM(NUM_PEDIDO) AS  NUME_INTERNO,0 CARTERA, PERIODO,	
	    TRIM(CODI_BODEGA) CODI_BODEGA    ,0 VALOR_OTRAMONE,0  IVA_OTRAMONE,
		case  when CODI_CAUSA='' THEN '99' ELSE TRIM(CODI_CAUSA) END  CODI_CAUSA, 
		CAST(CAST(COALESCE (IVA_PESOS,0) AS FLOAT64) AS NUMERIC)  IVA,
		CAST(CAST(COALESCE (PRECIO_UNITARIO,0) AS FLOAT64) AS NUMERIC)   VALOR_UNITARIO ,'' TIPO_ARTFISCAL, TRIM(COD_TIPODOCU) TIPO_DOCU,
		CASE  CODI_EMPRESA  
				WHEN 'GA' THEN 1  
				WHEN 'DN' THEN 2   ELSE 3  END CODI_ESTRUCTURA, '' NUMERO_LEGAL,0 ID_FECHA,
				TRIM(NUM_PEDIDO) NUMERO_PEDIDO,
		case  when CODI_SUBCAUSA='' THEN '99' ELSE TRIM(CODI_SUBCAUSA) END CODI_SUBCAUSA, 
		0 CODIGO_CAUSAL,LINEA AS LINEA_NUMERO,
		 CAST(PARSE_DATE("%Y%m%d", CAST(FECHA_FACTURA + 19000000 AS STRING)) AS TIMESTAMP) FECHA_REQU_PED,
		0 ID_FECHA_REQ,	cast(cast( INDICA_KIT as string) as INT64) INDICA_KIT ,
		CAST(CAST(TOT_ARTKIT AS FLOAT64 ) AS INT64) TOT_ARTKIT  ,1  PADRE_KIT  ,  
		CAST(CAST(DESC_ARTICULO	AS FLOAT64)  AS NUMERIC) DESCU_ARTICULO,0 DESC_POSV
		FROM         COMERCIAL.VIVENTAS_1   V   
	    WHERE     (V.COD_TIPODOCU = 'CR')   
		AND V.PERIODO =${PERIODO}
		AND FECHA_FACTURA <>0
		and CODI_CAUSA <>'V'
		AND (PRECIO_PESOS <>0  );
