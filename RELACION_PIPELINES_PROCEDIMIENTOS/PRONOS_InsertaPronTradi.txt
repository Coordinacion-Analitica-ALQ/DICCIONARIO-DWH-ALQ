SELECT FN.PERIODO() AS PERIODO;

DECLARE diasht FLOAT64 DEFAULT (SELECT DIAS_HABILES FROM COMERCIAL.PERIODO_DIASH WHERE PERIODO = ${PERIODO} LIMIT 1);

DELETE COMERCIAL.PRONOSTICO_TRADICIONALN WHERE PERIODO=${PERIODO};

INSERT INTO COMERCIAL.PRONOSTICO_TRADICIONALN
(PERIODO, CODI_EMPRESA, CODI_UNIDAD, CODI_REGIONAL, CODI_CANALAGRUP, CODI_CANALSUPE, 
CODI_CANAL, CODI_DISTRITO, CODIGO_DISTRITO_DASA, CODI_ZONA, CODI_ZONA_DASA,  CODI_LINEA, 
CODI_GRUPO, CODI_SUBGRUPO, 
CODI_PRESENTACION, CODI_TAMANO, CODIGO_EMP_FISCAL, CODIGO_MARCA,   LITROS_DIA, 
LITROS_MES, PESOS_MES, VALOR_PROMEDIO, NOMBRE_EMPRESA, NOMBRE_UNIDAD, NOMBRE_REGION, 
NOMBRE_CANALAGRUP, NOMBRE_CANALSUPE, NOMBRE_CANAL, NOMBRE_DISTRITO, NOMBRE_DISTRITO_DASA, 
NOMBRE_ZONA, NOMBRE_ZONA_DASA,   NOMBRE_EMP_FISCAL, NOMBRE_MARCA, 
CATEGORIA_COMERCIAL, DESCRIPCION, DESC_LINEA, DESC_GRUPO, DESC_SUBGRUPO, DESC_PRESENTACION, 
DESC_TAMANO,CATEGORIA_COMERCIAL_MODERNO,CODI_ARTICULO,CODI_ARTEMP,
CODIGO_REGIONSUPE,REGIONAL_SUPERIOR,CODIGO_SECTOR,SECTOR)

SELECT  CAST(PERIODO AS INT64), SUBSTRING(CODIGO_EMPRESA ,1,2) CODI_EMPRESA, SUBSTRING(CODIGO_REGIONAL,1,3) CODI_UNIDAD, 
SUBSTRING(CODIGO_REGION,1,3),   SUBSTRING(CODIGO_CANAL_AGRUP,1,2) , 
SUBSTRING(CODIGO_CANALSUPE,1,2)  , SUBSTRING(CODIGO_CANAL_INF,1,2)  , 
SUBSTRING(CODIGO_DISTRITO ,1,2) ,SUBSTRING(CODIGO_DISTRITO_DASA,1,2) , 
SUBSTRING(CODIGO_ZONA,1,2)  , SUBSTRING(CODIGO_ZONA_DASA,1,2)  , 
SUBSTRING(CODIGO_CATEGORIA,1,2)   , SUBSTRING(CODIGO_GRUPO,1,2)  , 
SUBSTRING(CODIGO_SUBGRUPO,1,3 )  , SUBSTRING(CODIGO_PRESENTACION,1,2) , 
SUBSTRING(CODIGO_TAMANO,1,10) , SUBSTRING(CODIGO_EMP_FISCAL ,1,2)  , 
SUBSTRING(CODIGO_MARCA ,1,2) ,
CASE WHEN diasht=0 then 0 else CAST(LITRO_NETO AS NUMERIC)/ CAST(diasht AS NUMERIC)  end  LITRO_DIA , CAST(LITRO_NETO AS NUMERIC), 
CAST(VALOR_NETO AS NUMERIC)  ,CAST(VALOR_PROMEDIO AS NUMERIC) ,SUBSTRING(NOMBRE_EMPRESA,1,50) ,SUBSTRING(NOMBRE_REGIONAL,1,50)  , 
SUBSTRING(NOMBRE_REGION,1,50) , SUBSTRING(NOMBRE_CANAL_AGRUPA,1,50)  , 
SUBSTRING(NOMBRE_CANALSUPE,1,50) ,SUBSTRING(NOMBRE_CANAL,1,50) , 
SUBSTRING(NOMBRE_DISTRITO,1,50) , SUBSTRING(NOMBRE_DISTRITO_DASA,1,50)  , 
SUBSTRING(NOMBRE_ZONA,1,50) , SUBSTRING(NOMBRE_ZONA_DASA,1,50) , 
SUBSTRING( NOMBRE_EMP_FISCAL ,1,50) , 
SUBSTRING(NOMBRE_MARCA,1,50), SUBSTRING(NOMBRE_CATEGORIA_COMERCIAL,1,50) ,
SUBSTRING(DESCRIPCION,1,50) DESCRIPCION, 
SUBSTRING(NOMBRE_CATEGORIA,1,50),SUBSTRING(NOMBRE_GRUPO,1,50) , 
SUBSTRING(NOMBRE_SUBGRUPO,1,50), SUBSTRING(NOMBRE_PRESENTACION,1,50) , 
SUBSTRING(NOMBRE_TAMANO,1,50) , categoria_comercial_moderno,CODIGO_ARTICULO,0,
substring(CODIGO_REGIONSUPE,1,3),substring(REGIONAL_SUPERIOR,1,50),substring(CODIGO_SECTOR,1,3),
substring(SECTOR,1,50)
FROM MAESTRO.PLANTILLA_CRYSTAL
where SUBSTRING(CODIGO_CANALSUPE,1,2) NOT  IN ('SM','ST','MQ') AND PERIODO=CAST(1 AS STRING)
and  CODIGO_EMPRESA  in ('GA','DN','FK');


UPDATE  COMERCIAL.PRONOSTICO_TRADICIONALN
SET CODI_ARTEMP=C.CODIGO 
FROM COMERCIAL.PRONOSTICO_TRADICIONALN AS P INNER JOIN MAESTRO.JERARQUIA_PRODUCTO AS C
ON P.CODI_EMPRESA=C.CODI_EMPRESA AND P.CODI_ARTICULO=C.CODI_ARTICULO  
WHERE P.PERIODO=${PERIODO}
AND C.CODI_EMPRESA IN ('GA','DN','FK');



--SELECT  PERIODO, SUBSTRING(CODIGO EMPRESA ,1,2) CODI_EMPRESA, SUBSTRING(CODIGO REGIONAL,1,3) CODI_UNIDAD, 
--SUBSTRING(CODIGO REGION,1,3) CODI_REGIONAL,   SUBSTRING(CODIGO CANAL_AGRUP,1,2)CODI_CANALAGRUP, 
-- SUBSTRING(CODIGO CANALSUPE,1,2) CODI_CANALSUPE, SUBSTRING(CODIGO CANAL INF,1,2) CODI_CANAL, 
--SUBSTRING(CODIGO DISTRITO ,1,2) CODI_DISTRITO,SUBSTRING(CODIGO DISTRITO DASA,1,2) CODIGO_DISTRITO_DASA, 
--SUBSTRING(CODIGO ZONA,1,2) CODI_ZONA, SUBSTRING(CODIGO ZONA DASA,1,2) CODI_ZONA_DASA,  
--SUBSTRING(CODIGO CATEGORIA,1,2)  CODI_LINEA, SUBSTRING(CODIGO GRUPO,1,2) CODI_GRUPO, 
--SUBSTRING(CODIGO SUBGRUPO,1,3 ) CODI_SUBGRUPO, SUBSTRING(CODIGO PRESENTACION,1,2) CODI_PRESENTACION, 
--SUBSTRING(CODIGO TAMANO,1,10) CODI_TAMANO, SUBSTRING(CODIGO_EMP_FISCAL,1,2) CODIGO_EMP_FISCAL, 
--SUBSTRING(CODIGO  MARCA,1,2) CODIGO_MARCA, 
--(LITRO NETO/ @DIASHT) LITROS_DIA, LITRO NETO LITROS_MES, VALOR NETO PESOS_MES, VALOR_PROMEDIO, 
--SUBSTRING(NOMBRE EMPRESA,1,50) NOMBRE_EMPRESA,SUBSTRING(NOMBRE REGIONAL,1,50) NOMBRE_UNIDAD, 
--SUBSTRING(NOMBRE REGION,1,50) NOMBRE_REGION, SUBSTRING(NOMBRE CANAL_AGRUPA,1,50)  NOMBRE_CANALAGRUP, 
--SUBSTRING(NOMBRE CANALSUPE,1,50)  NOMBRE_CANALSUPE,SUBSTRING(NOMBRE CANAL,1,50)  NOMBRE_CANAL, 
--SUBSTRING(NOMBRE DISTRITO,1,50) NOMBRE_DISTRITO, SUBSTRING(NOMBRE DISTRITO DASA,1,50)  NOMBRE_DISTRITO_DASA, 
--SUBSTRING(NOMBRE ZONA,1,50)  NOMBRE_ZONA, SUBSTRING(NOMBRE ZONA DASA,1,50) NOMBRE_ZONA_DASA, 
-- SUBSTRING(NOMBRE EMP_FISCAL,1,50) NOMBRE_EMP_FISCAL, 
--SUBSTRING(NOMBRE MARCA,1,50) NOMBRE_MARCA, SUBSTRING(NOMBRE CATEGORIA COMERCIAL,1,50) CATEGORIA_COMERCIAL,
--SUBSTRING(DESCRIPCION,1,50) DESCRIPCION, 
--SUBSTRING(NOMBRE CATEGORIA,1,50) DESC_LINEA,SUBSTRING(NOMBRE GRUPO,1,50) DESC_GRUPO, 
--SUBSTRING(NOMBRE SUBGRUPO,1,50) DESC_SUBGRUPO, SUBSTRING(NOMBRE PRESENTACION,1,50) DESC_PRESENTACION, 
--SUBSTRING(NOMBRE TAMANO,1,50) DESC_TAMANO 
--FROM dbo.PLANTILLA_DISTRITO



